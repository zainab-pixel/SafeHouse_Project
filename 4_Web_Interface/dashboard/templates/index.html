
<!DOCTYPE html>
<html lang="en" data-theme="auto" data-color-theme="green">
<head>
  <meta charset="UTF-8" />
  <title>SafeHouse ‚Äì Web Interface (Updated)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-main: #E8ECEF;
      --bg-panel: #FFFFFF;
      --bg-panel-soft: #DDE2E7;

      --text-main: #0A1C29;
      --text-soft: #64748B;
      --muted: #C0CAD5;
      --outline: rgba(0, 0, 0, 0.1);

      --accent: #2ec4b6;
      --accent-yellow: #e9d44d;
      --accent-orange: #ff9f1c;
      --danger: #d7263d;
      --emergency: #ff2a2a;

      --radius-lg: 20px;
      --radius-xl: 26px;
      --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.15);
      --transition-fast: 0.18s ease-out;
    }

    [data-theme="dark"] {
      --bg-main: #0A1C29;
      --bg-panel: #14283A;
      --bg-panel-soft: #1D344B;
      --text-main: #E8ECEF;
      --text-soft: #AAB9C8;
      --muted: #334D66;
      --outline: rgba(255, 255, 255, 0.08);
      --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      background: radial-gradient(circle at top left, var(--bg-panel-soft) 0%, var(--bg-main) 50%, var(--bg-main) 100%);
      color: var(--text-main);
    }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
    }

    /* =========================
       TOASTS
       ========================= */
    .toasts {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 50;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--bg-panel);
      color: var(--text-main);
      border: 1px solid var(--outline);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
      font-size: 12px;
      min-width: 220px;
      cursor: pointer;
    }
    .toast.success { border-color: rgba(32, 163, 158, 0.6); }
    .toast.info { border-color: rgba(59, 130, 246, 0.6); }
    .toast.danger { border-color: rgba(209, 0, 90, 0.6); }
    .toast.emergency {
      border-color: rgba(255, 42, 42, 0.6);
      background: rgba(255, 42, 42, 0.1);
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 42, 42, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(255, 42, 42, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 42, 42, 0); }
    }

    /* =========================
       LOGIN SCREEN
       ========================= */
    .auth-wrapper {
      width: 100%;
      max-width: 420px;
      background: var(--bg-panel);
      border-radius: 30px;
      padding: 26px 24px 22px;
      box-shadow: var(--shadow-soft);
      display: none;
      position: relative;
      overflow: hidden;
      border: 1px solid var(--outline);
    }

    .auth-logo {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 40px;
      margin-bottom: 20px;
      font-weight: 600;
      gap: 10px;
    }

    .auth-wrapper::before {
      content: "";
      position: absolute;
      width: 220px;
      height: 220px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, rgba(46, 196, 182, 0.12), transparent 65%);
      top: -80px;
      right: -110px;
    }

    .auth-header { position: relative; margin-bottom: 18px; }
    .auth-title { font-size: 20px; font-weight: 600; color: var(--text-main); }
    .auth-subtitle { margin-top: 4px; font-size: 13px; color: var(--text-soft); }

    .auth-badge {
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(46, 196, 182, 0.08);
      color: var(--accent);
      font-size: 11px;
    }

    .auth-badge-dot { width: 8px; height: 8px; border-radius: 999px; background: var(--accent); }

    .auth-form { position: relative; display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .auth-label { font-size: 12px; font-weight: 500; color: var(--text-main); margin-bottom: 2px; }
    .auth-field { position: relative; }
    .auth-input {
      width: 100%;
      border-radius: 14px;
      border: 1px solid var(--outline);
      padding: 9px 11px;
      font-size: 13px;
      outline: none;
      transition: border var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
      background: var(--bg-panel-soft);
      color: var(--text-main);
    }
    .auth-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(46, 196, 182, 0.28);
      background: var(--bg-panel);
    }

    .eye-btn {
      position: absolute; right: 10px; top: 50%;
      transform: translateY(-50%);
      background: transparent; border: 0; cursor: pointer;
      font-size: 14px; color: var(--text-soft);
    }

    .auth-footer-row { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-top: 4px; }
    .auth-remember { display: inline-flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-soft); cursor: pointer; user-select: none; }
    .auth-checkbox { width: 14px; height: 14px; border-radius: 4px; border: 1px solid var(--outline); display: inline-flex; align-items: center; justify-content: center; font-size: 11px; color: var(--accent); }
    .auth-link { font-size: 11px; color: var(--accent-orange); text-decoration: underline; cursor: pointer; white-space: nowrap; }

    .auth-button {
      margin-top: 12px;
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      background: var(--accent);
      color: var(--bg-panel);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 14px 30px rgba(46, 196, 182, 0.28);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), opacity var(--transition-fast);
    }
    .auth-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(46, 196, 182, 0.38);
    }

    .auth-button.emergency {
      background: var(--emergency);
      box-shadow: 0 14px 30px rgba(255, 42, 42, 0.28);
    }
    .auth-button.emergency:hover {
      box-shadow: 0 18px 40px rgba(255, 42, 42, 0.38);
    }

    .auth-hint { margin-top: 10px; font-size: 11px; color: var(--text-soft); background: var(--bg-panel-soft); border-radius: 12px; padding: 8px 9px; }
    .auth-hint code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 10px; padding: 1px 4px; background: var(--bg-panel); border-radius: 6px; color: var(--text-main); }
    .auth-error { margin-top: 8px; font-size: 11px; color: var(--danger); display: none; }

    /* =========================
       APP SHELL
       ========================= */
    .app { max-width: 100vw; width: 100vw; height: 100vh; display: none; }
    .app-shell {
      width: 100vw;
      height: 100vh;
      background: radial-gradient(circle at top left, var(--bg-panel-soft) 0%, var(--bg-main) 50%, var(--bg-main) 100%);
      position: relative;
      overflow: hidden;
      display: grid;
      grid-template-columns: 1fr;
    }

    .main { display: grid; grid-template-rows: auto 1fr; padding: 18px 22px; gap: 16px; position: relative; }
    .topbar { display: flex; align-items: center; justify-content: space-between; gap: 12px; }

    .custom-header-title {
      font-size: 18px; letter-spacing: 0.14em; text-transform: uppercase;
      font-weight: 800; color: var(--text-main);
      display: inline-flex; align-items: center; gap: 8px;
    }

    .top-right { display: flex; align-items: center; gap: 8px; }

    .btn {
      font-size: 12px;
      border: 1px solid var(--outline);
      background: var(--bg-panel-soft);
      color: var(--text-main);
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all var(--transition-fast);
      user-select: none;
    }
    .btn:hover { box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1); }
    .btn.danger { border-color: rgba(209, 0, 90, 0.6); color: var(--bg-panel); background: linear-gradient(135deg, #FF6961, var(--danger)); }
    .btn.emergency {
      border-color: rgba(255, 42, 42, 0.6);
      color: var(--bg-panel);
      background: linear-gradient(135deg, #FF6961, var(--emergency));
      animation: pulse 2s infinite;
    }
    .btn.secondary { background: rgba(46, 196, 182, 0.1); color: var(--accent); border-color: rgba(46, 196, 182, 0.3); }
    .btn.edit { background: rgba(46, 196, 182, 0.1); color: var(--accent); border-color: rgba(46, 196, 182, 0.3); }
    .btn.delete { background: rgba(215, 38, 61, 0.1); color: var(--danger); border-color: rgba(215, 38, 61, 0.3); }
    .btn.small { padding: 6px 10px; font-size: 12px; }

    main { position: relative; display: grid; grid-template-columns: minmax(0, 2fr) minmax(260px, 1fr); gap: 20px; align-items: stretch; }
    .house-column { display: flex; flex-direction: column; gap: 16px; }
    .phone-column { display: flex; align-items: center; justify-content: center; }

    .greeting-card { display: flex; flex-direction: column; gap: 4px; }
    .greeting-title { font-size: 14px; letter-spacing: 0.16em; text-transform: uppercase; font-weight: 600; color: var(--text-main); }
    .greeting-sub { font-size: 13px; color: var(--text-soft); }
    .greeting-row { display: flex; align-items: center; gap: 12px; margin-top: 4px; }
    .greeting-badge { font-size: 11px; padding: 4px 8px; border-radius: 999px; background: var(--bg-panel-soft); color: var(--text-soft); display: inline-flex; align-items: center; gap: 6px; }
    .greeting-badge span.dot { width: 8px; height: 8px; border-radius: 999px; background: var(--accent); }

    .house-card {
      position: relative;
      border-radius: var(--radius-xl);
      overflow: hidden;
      background: var(--bg-panel);
      padding: 18px;
      color: var(--text-main);
      min-height: 250px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--outline);
    }

    .house-illustration { position: absolute; inset: 0; padding: 10px; pointer-events: none; opacity: 1; display: flex; align-items: center; justify-content: center; }
    .floor-plan { position: relative; width: 100%; height: 100%; max-height: 280px; border: 4px solid var(--accent); background-color: var(--bg-main); }

    .wall-vertical { position: absolute; left: 40%; top: 0; bottom: 0; width: 3px; background: var(--accent); }
    .wall-horizontal-top { position: absolute; left: 40%; right: 0; top: 35%; height: 3px; background: var(--accent); }
    .wall-horizontal-bottom { position: absolute; left: 0; right: 0; top: 65%; height: 3px; background: var(--accent); }
    .doorway { position: absolute; left: 40%; top: 40%; width: 6px; height: 10%; background: var(--bg-main); z-index: 5; }

    .room-label { position: absolute; font-size: 10px; font-weight: 600; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.1em; }
    .room-label.a { top: 15%; left: 5%; }
    .room-label.b { top: 5%; right: 5%; }
    .room-label.c { top: 70%; left: 5%; }
    .room-label.d { bottom: 5%; right: 5%; }

    .house-caption { position: relative; margin-top: auto; z-index: 10; padding: 6px 0; border-radius: 8px; }
    :root[data-theme="light"] .house-caption { background: rgba(255, 255, 255, 0.9); color: var(--text-main); }
    :root[data-theme="dark"] .house-caption { background: rgba(8, 12, 16, 0.45); color: var(--text-main); backdrop-filter: blur(6px); }
    .house-caption-sub { font-size: 12px; color: var(--text-soft); margin-top: 2px; }

    .bubbles { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; }
    .bubble-card {
      background: linear-gradient(135deg, var(--bg-panel-soft), var(--bg-panel));
      border-radius: 22px;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--outline);
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
      color: var(--text-main);
    }
    .bubble-card:hover { transform: translateY(-3px); box-shadow: 0 14px 30px rgba(0, 0, 0, 0.15); background: linear-gradient(135deg, #EBEFF3, #F5F9FC); }
    .bubble-icon { width: 38px; height: 38px; border-radius: 999px; display: flex; align-items: center; justify-content: center; background: rgba(46, 196, 182, 0.08); font-size: 20px; flex-shrink: 0; }
    .bubble-title { font-size: 13px; font-weight: 600; color: var(--text-main); }
    .bubble-sub { font-size: 11px; color: var(--text-soft); }
    .bubble-content { flex: 1; display: flex; flex-direction: column; gap: 2px; }

    .bubble-card.is-disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .bubble-card.is-disabled:hover { transform: none; box-shadow: 0 10px 24px rgba(0,0,0,0.1); }

    .phone-shell { width: 260px; max-width: 100%; border-radius: 32px; padding: 14px 10px; background: var(--text-main); box-shadow: 0 18px 40px rgba(0, 0, 0, 0.4); position: relative; color: var(--bg-main); }
    .phone-notch { width: 56%; height: 9px; border-radius: 0 0 999px 999px; background: var(--text-main); position: absolute; top: 10px; left: 50%; transform: translateX(-50%); }
    .phone-screen { background: var(--bg-panel); border-radius: 24px; padding: 16px 14px 12px; margin-top: 14px; display: flex; flex-direction: column; gap: 12px; min-height: 360px; border: 1px solid var(--outline); color: var(--text-main); }

    .phone-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .phone-title { font-size: 14px; font-weight: 600; }
    .phone-header-sub { font-size: 11px; color: var(--text-soft); }
    .phone-badge { background: rgba(46, 196, 182, 0.08); color: var(--accent); font-size: 11px; padding: 4px 8px; border-radius: 999px; display: inline-flex; align-items: center; gap: 6px; }
    .phone-badge-dot { width: 7px; height: 7px; border-radius: 999px; background: var(--accent); }

    .phone-tools { display: flex; gap: 6px; align-items: center; }
    .search { width: 100%; display: flex; gap: 8px; align-items: center; background: var(--bg-panel-soft); border: 1px solid var(--outline); padding: 6px 10px; border-radius: 12px; font-size: 12px; color: var(--text-soft); }
    .search input { flex: 1; border: 0; outline: none; background: transparent; color: var(--text-main); font-size: 12px; }

    .phone-list { display: flex; flex-direction: column; gap: 8px; margin-top: 4px; }
    .phone-card { border-radius: 14px; padding: 8px 10px; background: var(--bg-panel); border: 1px solid var(--outline); display: flex; align-items: center; justify-content: space-between; gap: 10px; font-size: 12px; color: var(--text-main); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); }
    .phone-card-main { display: flex; flex-direction: column; gap: 2px; }
    .phone-card-label { font-weight: 500; color: var(--text-main); }
    .phone-card-sub { color: var(--text-soft); font-size: 11px; }

    .toggle { position: relative; width: 40px; height: 22px; border-radius: 999px; background: var(--bg-panel-soft); cursor: pointer; transition: background var(--transition-fast); flex-shrink: 0; border: none; }
    .toggle-circle { position: absolute; width: 18px; height: 18px; border-radius: 999px; background: var(--bg-panel); top: 2px; left: 2px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); transition: transform var(--transition-fast); }
    .toggle[data-on="true"] { background: var(--accent); }
    .toggle[data-on="true"] .toggle-circle { transform: translateX(18px); }

    .slider { -webkit-appearance: none; appearance: none; width: 100%; height: 4px; border-radius: 999px; background: var(--bg-panel-soft); outline: none; cursor: pointer; }
    .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--bg-panel); box-shadow: 0 0 12px rgba(46, 196, 182, 0.28); border: 3px solid var(--accent); }
    .slider::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: var(--bg-panel); border: 3px solid var(--accent); }

    .inline-btn { border: none; border-radius: 999px; padding: 6px 12px; font-size: 11px; cursor: pointer; background: var(--accent); color: var(--bg-panel); box-shadow: 0 6px 12px rgba(46, 196, 182, 0.28); }
    .link-btn { background: transparent; border: 0; color: var(--accent-orange); cursor: pointer; font-size: 11px; text-decoration: underline; margin-left: 6px; }

    .btn:focus-visible, .bubble-card:focus-visible, .toggle:focus-visible, .inline-btn:focus-visible, .link-btn:focus-visible, .auth-input:focus-visible, .phone-card:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* =========================
       MODALS
       ========================= */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease-out;
    }
    .modal-overlay.open { display: flex; opacity: 1; }
    .modal-content {
      width: 90%;
      max-width: 600px;
      background: var(--bg-panel);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      color: var(--text-main);
      transform: scale(0.95);
      transition: transform 0.3s ease-out;
      padding: 24px;
      border: 1px solid var(--outline);
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-overlay.open .modal-content { transform: scale(1); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .modal-close-btn { background: none; border: none; font-size: 18px; color: var(--text-soft); cursor: pointer; padding: 4px; }

    /* User info modal */
    .user-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    .user-info-item {
      padding: 10px;
      background: var(--bg-panel-soft);
      border-radius: 10px;
      border: 1px solid var(--outline);
    }
    .user-info-label {
      font-size: 10px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 4px;
    }
    .user-info-value {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
    }
    .user-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }

    .permissions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0; }
    .permission-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
    .permission-checkbox {
      width: 16px; height: 16px; border-radius: 4px;
      border: 1px solid var(--outline);
      display: flex; align-items: center; justify-content: center;
      color: var(--accent); cursor: pointer;
      transition: all var(--transition-fast);
      cursor: pointer !important;          /* Important pour voir la main */
      pointer-events: auto !important;
      position: relative !important;
      z-index: 9999 !important;
    }
    .permission-checkbox.checked { background: var(--accent); color: white; }
    .permission-checkbox.checked::after { content: "‚úì"; }

    /* Manage Users Modal */
    .manage-users-warning {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 13px;
      color: var(--text-main);
    }
    .users-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 5px;
    }
    .user-card {
      background: var(--bg-panel);
      border: 1px solid var(--outline);
      border-radius: 14px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 15px;
    }
    .user-card-info { flex: 1; }
    .user-card-name { font-size: 15px; font-weight: 600; color: var(--text-main); margin-bottom: 4px; }
    .user-card-email { font-size: 13px; color: var(--text-soft); margin-bottom: 8px; }
    .user-card-details { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
    .user-card-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--bg-panel-soft);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .user-card-badge.admin { background: rgba(46, 196, 182, 0.1); color: var(--accent); }
    .user-card-badge.regular { background: rgba(147, 197, 253, 0.1); color: #3b82f6; }
    .user-card-badge.viewer { background: rgba(209, 213, 219, 0.1); color: #6b7280; }
    .user-card-badge.online { background: rgba(34, 197, 94, 0.1); color: #16a34a; }
    .user-card-badge.offline { background: rgba(239, 68, 68, 0.1); color: #dc2626; }

    .user-card-actions { display: flex; gap: 8px; align-items: flex-start; }

    /* SOS modal */
    .sos-modal-content { max-width: 400px; text-align: center; }
    .sos-title { color: var(--emergency); font-size: 24px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .sos-warning {
      background: rgba(255, 42, 42, 0.1);
      border: 1px solid rgba(255, 42, 42, 0.3);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 13px;
      color: var(--text-main);
    }
    .sos-buttons { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
    .sos-button {
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    .sos-button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); }
    .sos-button.ambulance { background: linear-gradient(135deg, #ff6b6b, var(--emergency)); color: white; }
    .sos-button.civil-protection { background: linear-gradient(135deg, #4d96ff, #2c6bff); color: white; }

    /* Settings modal */
    .setting-section { margin-bottom: 20px; }
    .setting-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .setting-sub { font-size: 11px; color: var(--text-soft); margin-bottom: 10px; }
    .setting-form { display: flex; flex-direction: column; gap: 10px; }
    .setting-form .auth-button { margin-top: 4px; }
    .setting-form .auth-input { border-radius: 10px; padding: 8px 10px; }
    .modal-separator { border: none; border-top: 1px solid var(--muted); margin: 20px 0; }

    .theme-options { display: flex; background: var(--bg-panel-soft); border-radius: 12px; padding: 4px; gap: 4px; border: 1px solid var(--outline); }
    .theme-btn { flex: 1; padding: 8px 12px; border-radius: 9px; border: none; background: transparent; font-size: 12px; color: var(--text-soft); font-weight: 500; cursor: pointer; transition: background var(--transition-fast), color var(--transition-fast); }
    .theme-btn[aria-pressed="true"] { background: var(--bg-panel); color: var(--text-main); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }


    /* --- PASTE THIS IN YOUR CSS --- */
    .perm-btn {
    display: inline-block; padding: 10px 15px; margin: 5px;
    border: 1px solid #ccc; border-radius: 8px; cursor: pointer;
    background-color: white; transition: all 0.2s; font-size: 13px;
    user-select: none; color: #333;
    }
    .perm-btn.active {
    background-color: #d4edda; border-color: #28a745;
    color: #155724; font-weight: bold;
    }
    /* Visualization Modal */
    .visualization-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 20px 0;
    }
    .visualization-card {
      background: var(--bg-panel-soft);
      border-radius: 14px;
      padding: 16px;
      border: 1px solid var(--outline);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .visualization-title {
      font-size: 12px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .visualization-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-main);
    }
    .visualization-status {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      width: fit-content;
    }
    .visualization-status.on {
      background: rgba(46, 196, 182, 0.1);
      color: var(--accent);
    }
    .visualization-status.off {
      background: rgba(215, 38, 61, 0.1);
      color: var(--danger);
    }

    @media (max-width: 900px) {
      main { grid-template-columns: minmax(0, 1fr); }
      .phone-column { justify-content: flex-start; }
      .user-info-grid { grid-template-columns: 1fr; }
      .user-card { flex-direction: column; gap: 12px; }
      .user-card-actions { align-self: flex-end; }
      .visualization-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
      body { padding: 12px; }
      .topbar { flex-direction: column; align-items: flex-start; }
      .top-right { flex-wrap: wrap; justify-content: flex-start; }
      .modal-content { width: 95%; padding: 16px; }
    }
    /* --- New Interactive Styles --- */

/* Lighting Hotspots */
.hotspot {
    position: absolute;
    width: 24px;
    height: 24px;
    background: var(--bg-panel);
    border: 2px solid var(--accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 20;
    font-size: 14px;
    transition: all var(--transition-fast);
    pointer-events: auto; /* Enable clicking over the illustration */
}

.hotspot[data-active="true"] {
    background: var(--accent-yellow);
    box-shadow: 0 0 15px var(--accent-yellow);
    border-color: #fff;
}

/* Door Elements */
.door-container {
    position: absolute;
    left: -4px; /* Align with left border */
    top: 40%;
    width: 8px;
    height: 15%;
    z-index: 30;
    pointer-events: auto;
}

.door-frame {
    position: absolute;
    width: 100%;
    height: 100%;
    background: var(--bg-main); /* 'Cuts' the green border */
}

.door-leaf {
    position: absolute;
    width: 100%;
    height: 100%;
    background: var(--accent);
    transform-origin: left center;
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
}

.door-leaf[data-open="true"] {
    transform: rotateY(-90deg);
}
/* Default state */
.bulb-off {
  background-color: #555; /* Dim color */
  transition: all 0.3s ease;
}

/* Synchronized state */
.bulb-on {
  background-color: #ff9f1c; /* Warm yellow from your palette */
  box-shadow: 0 0 20px #ff9f1c, 0 0 40px rgba(255, 159, 28, 0.6);
  filter: brightness(1.2);
}
/* This ensures the architectural bulb reacts to the 'data-active' attribute */
.hotspot[data-active="true"] {
    background: var(--accent-yellow) !important;
    box-shadow: 0 0 15px var(--accent-yellow), 0 0 30px rgba(233, 212, 77, 0.6) !important;
    transform: scale(1.2);
    transition: all 0.3s ease;
}
/* Architectural Hotspot Active State */
.hotspot.is-active {
  background-color: var(--accent-yellow) !important;
  border-color: #fff !important;
  box-shadow: 0 0 15px 5px rgba(233, 212, 77, 0.6), 
              0 0 30px 10px rgba(233, 212, 77, 0.3);
  transform: scale(1.2); /* Slightly enlarge the bulb when on */
  transition: all 0.3s ease;
}

/* Optional: Subtle pulse animation for active lights */
.hotspot.is-active::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  border-radius: 50%;
  animation: pulse-glow 2s infinite;
}

@keyframes pulse-glow {
  0% { box-shadow: 0 0 0 0 rgba(233, 212, 77, 0.7); }
  70% { box-shadow: 0 0 0 15px rgba(233, 212, 77, 0); }
  100% { box-shadow: 0 0 0 0 rgba(233, 212, 77, 0); }
}
  </style>
</head>
<style>
    /* Green buttons for permissions */
    .perm-btn {
        padding: 10px; border: 1px solid #ccc; border-radius: 5px; 
        cursor: pointer; background: white; margin: 2px;
    }
    .perm-btn.active {
        background-color: #d4edda; border-color: #28a745; color: #155724; font-weight: bold;
    }
</style>
<body>
  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <section class="auth-wrapper" id="auth-wrapper" aria-label="Login">
    <div class="auth-header">
      <div class="auth-logo">
        <img src="maison.png" alt="Home" style="width:80px;height:80px;">
        <h2 class="auth-title">SafeHouse</h2>
      </div>
      <p class="auth-subtitle">Log in to access your secure dashboard.</p>
      <div class="auth-badge">
        <span class="auth-badge-dot"></span>
        Desktop &amp; Mobile Compatible
      </div>
    </div>
    
    <form class="auth-form" id="auth-form" autocomplete="on">
      <div class="auth-field">
        <label class="auth-label" for="auth-email">Email Address</label>
        <input class="auth-input" id="auth-email" type="email" placeholder="ex. user@safehouse.com" required inputmode="email" />
      </div>

      <div class="auth-field">
        <label class="auth-label" for="auth-password">Password</label>
        <input class="auth-input" id="auth-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
        <button class="eye-btn" type="button" aria-label="Show/Hide Password" id="toggle-pwd">üëÅ</button>
      </div>

      <div class="auth-footer-row">
        <label class="auth-remember" for="remember-input">
          <span class="auth-checkbox" id="remember-box">‚úî</span>
          <input id="remember-input" type="checkbox" hidden aria-hidden="true" />
          <span>Remember Me</span>
        </label>
        <span class="auth-link" id="forgot-link">Forgot Password?</span>
      </div>

      <button class="auth-button" type="submit">
        Log In <span>‚û°Ô∏è</span>
      </button>

      <p class="auth-error" id="auth-error">Incorrect credentials. Please try again.</p>

      <p class="auth-hint">
        For demo, use:
        <strong>Email:</strong> <code>user@home.com</code> &nbsp; | &nbsp;
        <strong>Password:</strong> <code>secret123</code>
      </p>
    </form>
  </section>

  <div class="app" id="app" role="application" aria-label="SafeHouse Dashboard">
    <div class="app-shell">
      <div class="main">
        <div class="topbar">
          <div class="custom-header-title">
            <img src="maison.png" alt="Home" style="width:80px;height:80px;margin-right:10px;">
            SAFEHOUSE ‚Äì PROTECTED HOME
          </div>

          <div class="top-right">
            <button class="btn emergency" id="sos-btn" title="Emergency SOS">üö® SOS</button>
           <button class="btn" id="history-btn" title="View Logs">üìú History</button>
            <!-- Bouton Visualization -->
            <button class="btn secondary" id="visualization-btn" title="Visualization">üìä Visualization</button>

            <button class="btn secondary" id="user-btn" title="User Profile">üë§ User</button>
            <button class="btn" id="settings-btn" title="Settings">‚öôÔ∏è Settings</button>
            <button class="btn" id="logout-btn" title="Logout">üîí Logout</button>
          </div>
        </div>

<main>
          <div class="house-column">
            <section class="greeting-card" aria-label="House Summary">
              <h1 class="greeting-title" id="welcome-title">WELCOME BACK, JOHN DOE!</h1>

              <div class="greeting-sub">
                Monitor and control your home in real-time, wherever you are, with SafeHouse.
              </div>

              <div class="greeting-row">
                <div class="greeting-badge">
                  <span class="dot"></span> Online
                </div>
                <div class="greeting-badge" id="first-login-badge" style="display: none;">
                  <span style="background: var(--accent-yellow)"></span> First Login - Change Password Required
                </div>
              </div>
            </section>

            <section class="house-card" aria-hidden="true">
              <div class="house-illustration">
                <div class="floor-plan">
                  <div class="wall-vertical"></div>
                  <div class="wall-horizontal-top"></div>
                  <div class="wall-horizontal-bottom"></div>
                  <div class="doorway"></div>

                  <span class="room-label a">Living Room</span>
                  <span class="room-label b">Kitchen</span>
                  <span class="room-label c">Bedroom</span>
                  <span class="room-label d">Bathroom</span>
                </div>
                <div class="hotspot" style="top: 20%; left: 20%;" id="hp-living" data-id="light-living">üí°</div>
    <div class="hotspot" style="top: 15%; right: 15%;" id="hp-kitchen" data-id="light-kitchen">üí°</div>
    <div class="hotspot" style="top: 75%; left: 20%;" id="hp-bedroom" data-id="light-bedroom">üí°</div>

    <div class="door-container" id="main-door-trigger">
        <div class="door-frame"></div>
        <div class="door-leaf" id="door-leaf"></div>
    </div>
              </div>
              <div class="house-caption">
                <div class="house-caption-sub">Architectural Floor Plan View.</div>
              </div>
            </section>

            <nav class="bubbles" aria-label="Module Shortcuts">
              <button class="bubble-card" data-target="lights" aria-pressed="true">
                <div class="bubble-icon">üí°</div>
                <div class="bubble-content">
                  <span class="bubble-title">Lighting</span>
                  <span class="bubble-sub">Living &amp; kitchen on</span>
                </div>
              </button>

              <button class="bubble-card" data-target="climate" aria-pressed="false">
                <div class="bubble-icon">üå°Ô∏è</div>
                <div class="bubble-content">
                  <span class="bubble-title">Climate</span>
                  <span class="bubble-sub">21&nbsp;¬∞C Comfort</span>
                </div>
              </button>

              <button class="bubble-card" data-target="gas" aria-pressed="false" title="Gas Detection">
                <div class="bubble-icon">üî•</div>
                <div class="bubble-content">
                  <span class="bubble-title">Gas Detection</span>
                  <span class="bubble-sub">Normal</span>
                </div>
              </button>

              <button class="bubble-card" data-target="garage" aria-pressed="false">
                <div class="bubble-icon">üö™</div>
                <div class="bubble-content">
                  <span class="bubble-title">Door</span>
                  <span class="bubble-sub">Door closed</span>
                </div>
              </button>

              <button class="bubble-card" data-target="movement" aria-pressed="false">
                <div class="bubble-icon">üëÅÔ∏è</div>
                <div class="bubble-content">
                  <span class="bubble-title">Movement Detection</span>
                  <span class="bubble-sub">2 sensors active</span>
                </div>
              </button>
            </nav>
          </div>

          <aside class="phone-column" aria-label="Smartphone Control">
            <div class="phone-shell">
              <div class="phone-notch"></div>
              <div class="phone-screen">
                <div class="phone-header">
                  <div>
                    <div class="phone-title" id="phone-username">SafeHouse ‚Ä¢ John Doe</div>
                    <div class="phone-header-sub">Main Dashboard</div>
                  </div>
                  <div class="phone-tools">
                    <div class="phone-badge">
                      <span class="phone-badge-dot"></span>
                      Online
                    </div>
                  </div>
                </div>

                <div class="search" role="search">
                  üîé
                  <input id="phone-search" type="search" placeholder="Search for a device or option‚Ä¶" aria-label="Search">
                </div>

                <div class="phone-list" id="phone-list"><div class="phone-card" tabindex="0" data-search="living room lights "><div class="phone-card-main"><div class="phone-card-label">Living Room Lights</div></div><div><button type="button" class="toggle" data-on="true" role="switch" aria-checked="true" aria-label="Living Room Lights"><span class="toggle-circle"></span></button></div></div><div class="phone-card" tabindex="0" data-search="kitchen lights "><div class="phone-card-main"><div class="phone-card-label">Kitchen Lights</div></div><div><button type="button" class="toggle" data-on="true" role="switch" aria-checked="true" aria-label="Kitchen Lights"><span class="toggle-circle"></span></button></div></div><div class="phone-card" tabindex="0" data-search="bedroom lighting bedroom illumination"><div class="phone-card-main"><div class="phone-card-label">Bedroom Lighting</div><div class="phone-card-sub">Bedroom illumination</div></div><div><button type="button" class="toggle" data-on="false" role="switch" aria-checked="false" aria-label="Bedroom Lighting"><span class="toggle-circle"></span></button></div></div></div>
              </div>
            </div>
          </aside>
        </main>
      </div>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div class="modal-overlay" id="forgot-password-modal">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="forgot-password-title">
      <div class="modal-header">
        <h3 class="modal-title" id="forgot-password-title">üîê Forgot Password</h3>
        <button class="modal-close-btn" id="forgot-password-close-btn" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="setting-sub">Enter your email address to receive a reset code.</p>
        <form id="forgot-password-form" class="setting-form">
          <div class="auth-field">
            <label class="auth-label" for="forgot-password-email">Email Address *</label>
            <input type="email" class="auth-input" id="forgot-password-email" placeholder="user@example.com" required />
          </div>

          <button type="submit" class="auth-button" id="forgot-password-submit">
            Send Reset Code
          </button>
          <p class="auth-error" id="forgot-password-error" style="display: none;"></p>

          <p class="setting-sub" style="margin-top:10px;">
            Note: This demo is client-side only. It uses your email app (mailto:) to send the code.
          </p>
        </form>
      </div>
    </div>
  </div>

  <!-- First Login Change Password Modal -->
  <div class="modal-overlay" id="first-login-modal">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="first-login-title">
      <div class="modal-header">
        <h3 class="modal-title" id="first-login-title">üëã Welcome to SafeHouse</h3>
      </div>
      <div class="modal-body">
        <p class="setting-sub">This is your first login. For security reasons, you must change your default password.</p>
        <form id="first-login-form" class="setting-form">
          <input type="password" class="auth-input" id="first-current-password" placeholder="Current Password (default: secret123)" required />
          <input type="password" class="auth-input" id="first-new-password" placeholder="New Password (min. 8 characters)" minlength="8" required />
          <input type="password" class="auth-input" id="first-confirm-password" placeholder="Confirm New Password" minlength="8" required />

          <button type="submit" class="auth-button">
            Change Password & Continue
          </button>
          <p class="auth-error" id="first-login-error" style="display: none;"></p>
        </form>
      </div>
    </div>
  </div>

  <!-- User Info Modal -->
  <div class="modal-overlay" id="user-info-modal">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="user-info-title">
      <div class="modal-header">
        <h3 class="modal-title" id="user-info-title">üë§ User Information</h3>
        <button class="modal-close-btn" id="user-info-close-btn" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="user-info-grid">
          <div class="user-info-item">
            <div class="user-info-label">Full Name</div>
            <div class="user-info-value" id="user-full-name">John Doe</div>
          </div>
          <div class="user-info-item">
            <div class="user-info-label">Email Address</div>
            <div class="user-info-value" id="user-email">user@home.com</div>
          </div>
          <div class="user-info-item">
            <div class="user-info-label">Account Created</div>
            <div class="user-info-value" id="user-created">2024-01-15 10:30:00</div>
          </div>
          <div class="user-info-item">
            <div class="user-info-label">Last Login</div>
            <div class="user-info-value" id="user-last-login">2024-03-20 14:45:00</div>
          </div>
          <div class="user-info-item">
            <div class="user-info-label">User Role</div>
            <div class="user-info-value" id="user-role">Admin</div>
          </div>
          <div class="user-info-item">
            <div class="user-info-label">Account Status</div>
            <div class="user-info-value" id="user-status">Active</div>
          </div>
        </div>

        <div class="user-actions">
          <button class="auth-button" id="create-user-btn">Ôºã Create New User</button>
          <button class="btn secondary" id="manage-users-btn">üë• Manage Users</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Users Modal -->
  <div class="modal-overlay" id="manage-users-modal">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="manage-users-title">
      <div class="modal-header">
        <h3 class="modal-title" id="manage-users-title">üë• Manage Users</h3>
        <button class="modal-close-btn" id="manage-users-close-btn" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="manage-users-warning">
          <strong>‚ö†Ô∏è Note:</strong> View, edit, or delete user accounts. You cannot delete your own account here.
        </div>

        <div class="users-list" id="users-list"></div>

        <div class="user-actions">
            <div class="permission-item">
        
        </div>
        <div class="permission-item">
       
        </div>
          <button class="auth-button" id="add-user-btn">Ôºã Add New User</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal-overlay" id="edit-user-modal">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="edit-user-title">
      <div class="modal-header">
        <h3 class="modal-title" id="edit-user-title">‚úèÔ∏è Edit User</h3>
        <button class="modal-close-btn" id="edit-user-close-btn" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <form id="edit-user-form" class="setting-form">
          <input type="hidden" id="edit-user-id">

          <div class="auth-field">
            <label class="auth-label" for="edit-user-name">Full Name *</label>
            <input type="text" class="auth-input" id="edit-user-name" placeholder="Enter full name" required />
          </div>

          <div class="auth-field">
            <label class="auth-label" for="edit-user-email">Email Address *</label>
            <input type="email" class="auth-input" id="edit-user-email" placeholder="user@example.com" required />
          </div>

          <div class="auth-field">
            <label class="auth-label" for="edit-user-role">User Role *</label>
            <select class="auth-input" id="edit-user-role">
              <option value="regular">Regular User</option>
              <option value="admin">Administrator</option>
              <option value="viewer">Viewer Only</option>
            </select>
          </div>

          <div class="setting-section">
            <h4 class="setting-title">Permissions</h4>
            <p class="setting-sub">Admin role automatically gets all permissions</p>
            <div class="permissions-grid">
              
              <div class="permission-item" data-val="history">
                <span class="permission-checkbox"></span>
                <span>View History</span>
            </div>
              <div class="permission-item" data-val="scenes">
                  <span class="permission-checkbox"></span>
                  <span>Manage Scenes</span>
              </div>
              <div class="permission-item" data-val="users">
                  <span class="permission-checkbox"></span>
                  <span>Manage Users</span>
              </div>
              <div class="permission-item" data-val="settings">
                  <span class="permission-checkbox"></span>
                  <span>System Settings</span>
              </div>
            </div>
          </div>

          <div class="user-actions" style="margin-top: 20px;">
            <button type="submit" class="auth-button">Save Changes</button>
            <button type="button" class="btn secondary" id="reset-password-btn">üîë Reset Password</button>
          </div>

          <p class="auth-error" id="edit-user-error" style="display: none;"></p>
        </form>
      </div>
    </div>
  </div>

  <!-- Create New User Modal -->
  <div class="modal-overlay" id="create-user-modal">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="create-user-title">
      <div class="modal-header">
        <h3 class="modal-title" id="create-user-title">Ôºã Create New User</h3>
        <button class="modal-close-btn" id="create-user-close-btn" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <form id="create-user-form" class="setting-form">
          <div class="auth-field">
            <label class="auth-label" for="new-user-name">Full Name *</label>
            <input type="text" class="auth-input" id="new-user-name" placeholder="Enter full name" required />
          </div>

          <div class="auth-field">
            <label class="auth-label" for="new-user-email">Email Address *</label>
            <input type="email" class="auth-input" id="new-user-email" placeholder="user@example.com" required />
          </div>

          <div class="auth-field">
            <label class="auth-label" for="new-user-password">Password *</label>
            <input type="password" class="auth-input" id="new-user-password" placeholder="Enter password (min. 8 characters)" minlength="8" required />
          </div>

          <div class="auth-field">
            <label class="auth-label" for="new-user-role">User Role *</label>
            <select class="auth-input" id="new-user-role">
              <option value="regular">Regular User</option>
              <option value="admin">Administrator</option>
              <option value="viewer">Viewer Only</option>
            </select>
          </div>

          <div class="setting-section">
            <h4 class="setting-title">Permissions</h4>
            <p class="setting-sub">Admin role automatically gets all permissions</p>
            <div class="permissions-grid">
              <div class="permission-item">
                <span class="permission-checkbox" data-permission="view-devices"></span>
                <span>View Devices</span>
              </div>
              <div class="permission-item">
                <span class="permission-checkbox" data-permission="control-devices"></span>
                <span>Control Devices</span>
              </div>
              <div class="permission-item">
                <span class="permission-checkbox" data-permission="view-history"></span>
                <span>View History</span>
              </div>
              <div class="permission-item">
                <span class="permission-checkbox" data-permission="manage-scenes"></span>
                <span>Manage Scenes</span>
              </div>
              <div class="permission-item">
                <span class="permission-checkbox" data-permission="manage-users"></span>
                <span>Manage Users</span>
              </div>
              <div class="permission-item">
                <span class="permission-checkbox" data-permission="system-settings"></span>
                <span>System Settings</span>
              </div>
            </div>
          </div>

          <button type="button" id="btn-save-to-db" class="auth-button">Create User Account</button>
          <p class="auth-error" id="create-user-error" style="display: none;"></p>
        </form>
      </div>
    </div>
  </div>
  <!-- SOS Emergency Modal -->
  <div class="modal-overlay" id="sos-modal">
    <div class="modal-content sos-modal-content" role="dialog" aria-modal="true" aria-labelledby="sos-title">
      <div class="modal-header">
        <h3 class="modal-title sos-title" id="sos-title">üö® EMERGENCY SOS</h3>
        <button class="modal-close-btn" id="sos-close-btn" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="sos-warning">
          <strong>‚ö†Ô∏è WARNING:</strong> Only use in case of real emergency. False alarms may result in penalties.
        </div>

        <p>Select the emergency service you need:</p>

        <div class="sos-buttons">
          <button class="sos-button ambulance" id="call-ambulance-btn">
            üöë Call Ambulance<br><small>Medical Emergency</small>
          </button>

          <button class="sos-button civil-protection" id="call-civil-protection-btn">
            üöí Call Civil Protection<br><small>Fire or Rescue</small>
          </button>
        </div>

        <p style="margin-top: 20px; font-size: 11px; color: var(--text-soft);">
          Your location will be automatically shared with emergency services.
        </p>
      </div>
    </div>
  </div>

  <!-- Visualization Modal -->
  <div class="modal-overlay" id="visualization-modal">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="visualization-title">
      <div class="modal-header">
        <h3 class="modal-title" id="visualization-title">üìä System Visualization</h3>
        <button class="modal-close-btn" id="visualization-close-btn" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="setting-sub">Current status and values of key system parameters.</p>
        
        <div class="visualization-grid">
          <div class="visualization-card">
            <div class="visualization-title">Temperature</div>
            <div class="visualization-value" id="vis-temperature">21 ¬∞C</div>
            <div class="visualization-status on">Thermostat Active</div>
          </div>
          
          <div class="visualization-card">
            <div class="visualization-title">Living Room Lights</div>
            <div class="visualization-value" id="vis-living-lights">ON</div>
            <div class="visualization-status on">Active</div>
          </div>
          
          <div class="visualization-card">
            <div class="visualization-title">Kitchen Lights</div>
            <div class="visualization-value" id="vis-kitchen-lights">ON</div>
            <div class="visualization-status on">Active</div>
          </div>
          
          <div class="visualization-card">
            <div class="visualization-title">Bedroom Lighting</div>
            <div class="visualization-value" id="vis-bedroom-lights">OFF</div>
            <div class="visualization-status off">Inactive</div>
          </div>
          
          <div class="visualization-card">
            <div class="visualization-title">Main Door</div>
            <div class="visualization-value" id="vis-door">CLOSED</div>
            <div class="visualization-status on">Secured</div>
          </div>
          
          <div class="visualization-card">
            <div class="visualization-title">Gas Detection</div>
            <div class="visualization-value" id="vis-gas">NORMAL</div>
            <div class="visualization-status on">Monitoring</div>
          </div>
        </div>
        
        <div class="user-actions" style="margin-top: 20px;">
          <button class="btn secondary" id="refresh-visualization">üîÑ Refresh Data</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settings-modal-overlay">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">‚öôÔ∏è App Settings</h3>
        <button class="modal-close-btn" id="modal-close-btn" aria-label="Close Settings">‚úï</button>
      </div>
      <div class="modal-body">
        <section class="setting-section">
          <h4 class="setting-title">üîí Change Password</h4>
          <p class="setting-sub">Update your SafeHouse login password.</p>
          <form id="change-password-form" class="setting-form">
            <input type="password" class="auth-input" id="new-password" placeholder="New Password" required minlength="6" />
            <input type="password" class="auth-input" id="confirm-password" placeholder="Confirm New Password" required minlength="6" />
            <button type="submit" class="auth-button">Update Password</button>
            <p class="auth-error" id="password-error" style="display: none;">Passwords do not match or are too short.</p>
          </form>
        </section>

        <hr class="modal-separator" />

        <section class="setting-section">
          <h4 class="setting-title">üåì Dark Mode</h4>
          <p class="setting-sub">Switch between Light, Dark, or Auto theme.</p>
          <div class="theme-options" role="tablist" aria-label="Theme Mode Options">
            <button class="theme-btn" type="button" data-theme-val="light" aria-pressed="true">Light</button>
            <button class="theme-btn" type="button" data-theme-val="dark">Dark</button>
            <button class="theme-btn" type="button" data-theme-val="auto">Auto</button>
          </div>
        </section>

        <hr class="modal-separator" />

        <section class="setting-section">
          <h4 class="setting-title">üóëÔ∏è Delete Account</h4>
          <p class="setting-sub">This will permanently delete the currently logged-in account from this demo (local storage).</p>
          <button class="btn danger" id="delete-account-btn">Delete My Account</button>
        </section>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="history-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>System History</h3>
      <button class="modal-close-btn" id="history-close">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom:10px;">
        <button class="btn" id="show-logs">Events</button>
        <button class="btn" id="show-sensors">Sensors</button>
      </div>
      <div id="log-list" style="height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px;">Loading...</div>
    </div>
  </div>
</div>

  <script>
    /* =========================
       Utilities & Storage
       ========================= */
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    const storage = {
      get(key, fallback) {
        try {
          const v = localStorage.getItem(key);
          return v ? JSON.parse(v) : fallback;
        } catch { return fallback; }
      },
      set(key, value) {
        try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
      },
      del(key) {
        try { localStorage.removeItem(key); } catch {}
      }
    };

    function toast(msg, type = "info", timeout = 3000) {
      const wrap = $("#toasts");
      const t = document.createElement("div");
      t.className = `toast ${type}`;
      t.innerHTML = `${type === "success" ? "‚úÖ" : type === "danger" ? "‚ö†Ô∏è" : type === "emergency" ? "üö®" : "‚ÑπÔ∏è"} <span>${msg}</span>`;
      wrap.appendChild(t);
      const rm = () => { t.remove(); };
      setTimeout(rm, timeout);
      t.addEventListener("click", rm);
    }

    function formatDateTime(value) {
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return String(value);
      return d.toLocaleDateString() + " " + d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function generateResetCode() {
      return String(Math.floor(100000 + Math.random() * 900000));
    }

    /* =========================
       User Management Data
       ========================= */
    const DEFAULT_USERS = [
      {
        id: 1,
        name: "John Doe",
        email: "user@home.com",
        role: "Admin",
        created: "2024-01-15 10:30:00",
        lastLogin: new Date().toISOString(),
        status: "Active",
        permissions: ["view-devices", "control-devices", "view-history", "manage-scenes", "manage-users", "system-settings"],
        passwordChanged: true,
        online: true,
        password: "secret123"
      },
    ];

    let users = storage.get("smartHomeUsers", DEFAULT_USERS);
    let currentUser = users[0];

    /* =========================
       Modal Management
       ========================= */
    function openModal(modalId) {
      const modal = $(`#${modalId}`);
      modal.classList.add("open");
      modal.style.display = "flex";
    }
    function closeModal(modalId) {
      const modal = $(`#${modalId}`);
      modal.classList.remove("open");
      setTimeout(() => { modal.style.display = "none"; }, 300);
    }
    function closeAllModals() {
      $$('.modal-overlay').forEach(modal => {
        modal.classList.remove("open");
        setTimeout(() => { modal.style.display = "none"; }, 300);
      });
    }

    /* =========================
       Theme Management
       ========================= */
    const THEME_KEY = "smartHomeTheme";
    const DEFAULT_COLOR_THEME = "green";
    document.documentElement.setAttribute("data-color-theme", DEFAULT_COLOR_THEME);

    function applyTheme(init = false, newTheme = null) {
      let theme = newTheme || storage.get(THEME_KEY, "light");
      let finalTheme = theme;

      if (theme === "auto") {
        finalTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      }

      document.documentElement.setAttribute("data-theme", finalTheme);

      $$(".theme-btn").forEach(btn => {
        btn.setAttribute("aria-pressed", btn.dataset.themeVal === theme ? "true" : "false");
      });

      if (newTheme) storage.set(THEME_KEY, newTheme);
    }

    /* =========================
       Authentication
       ========================= */
    const authWrapper = $("#auth-wrapper");
    const authForm = $("#auth-form");
    const authError = $("#auth-error");
    const rememberBox = $("#remember-box");
    const rememberInput = $("#remember-input");
    const appRoot = $("#app");
    const welcomeTitle = $("#welcome-title");
    const phoneUsername = $("#phone-username");
    const firstLoginBadge = $("#first-login-badge");

    function typewriter(el, text, speed = 35) {
      el.textContent = "";
      let i = 0;
      const tick = () => {
        el.textContent = text.slice(0, i);
        i++;
        if (i <= text.length) setTimeout(tick, speed);
      };
      tick();
    }

    function updateUserDisplay() {
      // Typewriter welcome text - TOUJOURS ACTIVE
      const wText = `WELCOME BACK, ${currentUser.name.toUpperCase()}!`;
      typewriter(welcomeTitle, wText, 30);

      phoneUsername.textContent = `SafeHouse ‚Ä¢ ${currentUser.name}`;

      if (!currentUser.passwordChanged) {
        firstLoginBadge.style.display = "inline-flex";
        setTimeout(() => openModal("first-login-modal"), 500);
      } else {
        firstLoginBadge.style.display = "none";
      }

      $("#user-full-name").textContent = currentUser.name;
      $("#user-email").textContent = currentUser.email;
      $("#user-role").textContent = currentUser.role;
      $("#user-status").textContent = currentUser.status;
      $("#user-created").textContent = formatDateTime(currentUser.created);
      $("#user-last-login").textContent = currentUser.lastLogin ? formatDateTime(currentUser.lastLogin) : "Never";
    }

    function showApp() {
      authWrapper.style.display = "none";
      appRoot.style.display = "block";
      updateUserDisplay();
    }

    function showLogin() {
      authWrapper.style.display = "block";
      appRoot.style.display = "none";
    }

    rememberBox.addEventListener("click", () => {
      rememberInput.checked = !rememberInput.checked;
      rememberBox.textContent = rememberInput.checked ? "‚úî" : "";
    });

    $("#toggle-pwd").addEventListener("click", () => {
      const pwd = $("#auth-password");
      pwd.type = pwd.type === "password" ? "text" : "password";
    });

    /* =========================
       FORGOT PASSWORD
       ========================= */
    $("#forgot-link").addEventListener("click", () => {
      closeAllModals();
      openModal("forgot-password-modal");
      $("#forgot-password-email").value = $("#auth-email").value || "";
    });

    $("#forgot-password-close-btn").addEventListener("click", () => {
      closeModal("forgot-password-modal");
    });

    $("#forgot-password-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const errorElem = $("#forgot-password-error");
      errorElem.style.display = "none";

      const email = $("#forgot-password-email").value.trim();
      if (!email || !email.includes("@")) {
        errorElem.textContent = "Please enter a valid email address.";
        errorElem.style.display = "block";
        return;
      }

      const user = users.find(u => u.email === email);
      if (!user) {
        errorElem.textContent = "No account found with this email address.";
        errorElem.style.display = "block";
        return;
      }

      const code = generateResetCode();
      const subject = encodeURIComponent("SafeHouse Password Reset Code");
      const body = encodeURIComponent(
        `Hello ${user.name},\n\nYour SafeHouse password reset code is: ${code}\n\nIf you did not request this, ignore this email.\n`
      );

      window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;

      toast(`Reset code generated and ready to send to ${email}`, "success", 5000);

      $("#forgot-password-form").reset();
      closeModal("forgot-password-modal");
    });

    /* =========================
       First login password change
       ========================= */
    $("#first-login-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const errorElem = $("#first-login-error");
      errorElem.style.display = "none";

      const currentPass = $("#first-current-password").value.trim();
      const newPass = $("#first-new-password").value.trim();
      const confirmPass = $("#first-confirm-password").value.trim();

      if (currentPass !== currentUser.password) {
        errorElem.textContent = "Current password is incorrect.";
        errorElem.style.display = "block";
        return;
      }
      if (newPass.length < 8) {
        errorElem.textContent = "New password must be at least 8 characters long.";
        errorElem.style.display = "block";
        return;
      }
      if (newPass !== confirmPass) {
        errorElem.textContent = "Passwords do not match.";
        errorElem.style.display = "block";
        return;
      }

      currentUser.password = newPass;
      currentUser.passwordChanged = true;

      const idx = users.findIndex(u => u.id === currentUser.id);
      if (idx !== -1) {
        users[idx].password = newPass;
        users[idx].passwordChanged = true;
        storage.set("smartHomeUsers", users);
      }

      closeModal("first-login-modal");
      firstLoginBadge.style.display = "none";
      toast("Password changed successfully!", "success", 3000);
    });

    // Auto login flag
    const isLogged = storage.get("smartHomeLogged", false) === true;
    if (isLogged) {
      const lastEmail = storage.get("smartHomeLastEmail", null);
      const u = lastEmail ? users.find(x => x.email === lastEmail) : null;
      currentUser = u || users[0];
      showApp();
    } else {
      showLogin();
    }

    
     /* =========================
       REAL DATABASE LOGIN
       ========================= */
    /* =========================
       REAL DATABASE LOGIN (FIXED)
       ========================= */
    authForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const authError = document.getElementById("auth-error");
      authError.style.display = "none";
      
      const email = document.getElementById("auth-email").value.trim();
      const pwd = document.getElementById("auth-password").value.trim();
      const btn = authForm.querySelector("button");
      const originalText = btn.innerHTML;

      // Visual feedback
      btn.innerHTML = "Verifying...";
      btn.disabled = true;

      // Send credentials to Django
      fetch('/api/login/', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ email: email, password: pwd })
      })
      .then(res => res.json())
      .then(data => {
          btn.innerHTML = originalText;
          btn.disabled = false;

          if (data.status === 'success') {
              // 1. Create Session User
              currentUser = {
                  name: data.user.name,
                  email: email,
                  role: data.user.role,
                  permissions: [], 
                  online: true,
                  passwordChanged: true // <--- THIS LINE STOPS THE MODAL
              };
              
              // 2. Remember login state
              const rememberInput = document.getElementById("remember-input");
              if (rememberInput && rememberInput.checked) {
                  storage.set("smartHomeLogged", true);
                  storage.set("smartHomeLastEmail", email);
              }

              // 3. Enter App
              // If you have a toast function, use it, otherwise alert
              if (typeof toast === "function") toast("Login successful!", "success");
              showApp();
              
          } else {
              // Login Failed
              authError.style.display = "block";
              authError.textContent = "‚ùå " + data.message;
          }
      })
      .catch(err => {
          btn.innerHTML = originalText;
          btn.disabled = false;
          console.error(err);
          authError.style.display = "block";
          authError.textContent = "‚ö†Ô∏è Server connection failed. Is Django running?";
      });
    });
    /* =========================
       User Info Modal
       ========================= */
    $("#user-btn").addEventListener("click", () => {
      openModal("user-info-modal");
      toast("Displaying User Profile...", "info");
    });

    $("#user-info-close-btn").addEventListener("click", () => closeModal("user-info-modal"));

    $("#create-user-btn").addEventListener("click", () => {
      closeModal("user-info-modal");
      setTimeout(() => {
        openModal("create-user-modal");
        $("#create-user-form").reset();
        $$('.permission-checkbox').forEach(cb => cb.classList.remove("checked"));
      }, 300);
    });

    $("#create-user-close-btn").addEventListener("click", () => closeModal("create-user-modal"));

    $("#manage-users-btn").addEventListener("click", () => {
      openModal("manage-users-modal");
      renderUsersList();
      toast("Opening user management...", "info");
    });

    $("#manage-users-close-btn").addEventListener("click", () => closeModal("manage-users-modal"));

    $("#add-user-btn").addEventListener("click", () => {
      closeModal("manage-users-modal");
      setTimeout(() => {
        openModal("create-user-modal");
        $("#create-user-form").reset();
        $$('.permission-checkbox').forEach(cb => cb.classList.remove("checked"));
      }, 300);
    });

    /* =========================
       Users List Rendering
       ========================= */
    function renderUsersList() {
      const usersList = $("#users-list");
      usersList.innerHTML = "";

      users.forEach(user => {
        const userCard = document.createElement("div");
        userCard.className = "user-card";
        userCard.dataset.userId = user.id;

        const isCurrentUser = user.id === currentUser.id;

        const createdText = user.created ? formatDateTime(user.created) : "Unknown";
        const lastLoginText = user.lastLogin ? formatDateTime(user.lastLogin) : "Never logged in";

        userCard.innerHTML = `
          <div class="user-card-info">
            <div class="user-card-name">${user.name}</div>
            <div class="user-card-email">${user.email}</div>
            <div class="user-card-details">
              <span class="user-card-badge ${user.role}">
                ${user.role === 'admin' ? 'üëë Admin' : user.role === 'regular' ? 'üë§ Regular User' : 'üëÅÔ∏è Viewer Only'}
              </span>
              <span class="user-card-badge ${user.online ? 'online' : 'offline'}">
                ${user.online ? '‚óè Online' : '‚óã Offline'}
              </span>
              <span class="user-card-badge">üìÖ Created: ${createdText}</span>
              <span class="user-card-badge">‚è± Last login: ${lastLoginText}</span>
            </div>
          </div>
          <div class="user-card-actions">
            <button class="btn edit" data-action="edit" data-user-id="${user.id}" ${isCurrentUser ? 'disabled title="Cannot edit your own account from here"' : ''}>
              ‚úèÔ∏è Edit
            </button>
            <button class="btn delete" data-action="delete" data-user-id="${user.id}" ${isCurrentUser ? 'disabled title="Cannot delete your own account"' : ''}>
              üóëÔ∏è Delete
            </button>
          </div>
        `;
        usersList.appendChild(userCard);
      });

      $$('[data-action="edit"]', usersList).forEach(btn => {
        btn.addEventListener("click", (e) => openEditUserModal(parseInt(e.target.dataset.userId)));
      });

      $$('[data-action="delete"]', usersList).forEach(btn => {
        btn.addEventListener("click", (e) => deleteUser(parseInt(e.target.dataset.userId)));
      });
    }

    function openEditUserModal(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      $("#edit-user-id").value = user.id;
      $("#edit-user-name").value = user.name;
      $("#edit-user-email").value = user.email;
      $("#edit-user-role").value = user.role;

      $$('.permission-checkbox').forEach(cb => cb.classList.remove("checked"));
      (user.permissions || []).forEach(p => {
        const cb = $(`.permission-checkbox[data-permission="${p}"]`);
        if (cb) cb.classList.add("checked");
      });

      if (user.role === "admin") {
        $$('.permission-checkbox').forEach(cb => { cb.style.opacity = "0.5"; cb.style.cursor = "not-allowed"; });
      } else {
        $$('.permission-checkbox').forEach(cb => { cb.style.opacity = "1"; cb.style.cursor = "pointer"; });
      }

      closeModal("manage-users-modal");
      setTimeout(() => openModal("edit-user-modal"), 300);
    }

    $("#edit-user-close-btn").addEventListener("click", () => {
      closeModal("edit-user-modal");
      setTimeout(() => openModal("manage-users-modal"), 300);
    });

    $("#edit-user-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const errorElem = $("#edit-user-error");
      errorElem.style.display = "none";

      const userId = parseInt($("#edit-user-id").value);
      const name = $("#edit-user-name").value.trim();
      const email = $("#edit-user-email").value.trim();
      const role = $("#edit-user-role").value;

      if (!name || !email) {
        errorElem.textContent = "Name and email are required.";
        errorElem.style.display = "block";
        return;
      }
      if (!email.includes("@")) {
        errorElem.textContent = "Please enter a valid email address.";
        errorElem.style.display = "block";
        return;
      }
      const existingUser = users.find(u => u.email === email && u.id !== userId);
      if (existingUser) {
        errorElem.textContent = "A user with this email already exists.";
        errorElem.style.display = "block";
        return;
      }

      const permissions = [];
      $$('.permission-checkbox').forEach(cb => {
        if (cb.classList.contains("checked")) permissions.push(cb.dataset.permission);
      });

      const idx = users.findIndex(u => u.id === userId);
      if (idx !== -1) {
        users[idx].name = name;
        users[idx].email = email;
        users[idx].role = role;
        users[idx].permissions = role === "admin"
          ? ["view-devices", "control-devices", "view-history", "manage-scenes", "manage-users", "system-settings"]
          : permissions;

        storage.set("smartHomeUsers", users);

        if (userId === currentUser.id) {
          currentUser = users[idx];
          updateUserDisplay();
        }
      }

      closeModal("edit-user-modal");
      setTimeout(() => {
        openModal("manage-users-modal");
        renderUsersList();
      }, 300);

      toast(`User ${name} updated successfully!`, "success", 3000);
    });

    $("#reset-password-btn").addEventListener("click", () => {
      const userId = parseInt($("#edit-user-id").value);
      const user = users.find(u => u.id === userId);
      if (!user) return;

      const newPassword = prompt(`Reset password for ${user.name}\n\nEnter new password (min. 8 characters):`, "newpassword123");
      if (newPassword && newPassword.length >= 8) {
        user.password = newPassword;
        user.passwordChanged = false;
        storage.set("smartHomeUsers", users);
        toast(`Password reset for ${user.name}. They will need to change it on next login.`, "success", 4000);
      } else if (newPassword !== null) {
        toast("Password must be at least 8 characters long.", "danger", 3000);
      }
    });

    $("#edit-user-role").addEventListener("change", function() {
      if (this.value === "admin") {
        $$('.permission-checkbox').forEach(cb => {
          cb.classList.add("checked");
          cb.style.opacity = "0.5";
          cb.style.cursor = "not-allowed";
        });
      } else {
        $$('.permission-checkbox').forEach(cb => {
          cb.style.opacity = "1";
          cb.style.cursor = "pointer";
        });
      }
    });

    function deleteUser(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      if (userId === currentUser.id) {
        toast("You cannot delete your own account here.", "danger", 3000);
        return;
      }

      if (confirm(`Are you sure you want to delete user "${user.name}" (${user.email})?`)) {
        users = users.filter(u => u.id !== userId);
        storage.set("smartHomeUsers", users);
        renderUsersList();
        toast(`User ${user.name} deleted successfully.`, "success", 3000);
      }
    }

    /* =========================
       Create User Form
       ========================= */
    $("#create-user-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const errorElem = $("#create-user-error");
      errorElem.style.display = "none";

      const name = $("#new-user-name").value.trim();
      const email = $("#new-user-email").value.trim();
      const password = $("#new-user-password").value.trim();
      const role = $("#new-user-role").value;

      if (!name || !email || !password) {
        errorElem.textContent = "All fields are required.";
        errorElem.style.display = "block";
        return;
      }
      if (password.length < 8) {
        errorElem.textContent = "Password must be at least 8 characters long.";
        errorElem.style.display = "block";
        return;
      }
      if (!email.includes("@")) {
        errorElem.textContent = "Please enter a valid email address.";
        errorElem.style.display = "block";
        return;
      }
      if (users.some(u => u.email === email)) {
        errorElem.textContent = "A user with this email already exists.";
        errorElem.style.display = "block";
        return;
      }

      const permissions = [];
      $$('.permission-checkbox').forEach(cb => {
        if (cb.classList.contains("checked")) permissions.push(cb.dataset.permission);
      });

      const now = new Date().toISOString();

      const newUser = {
        id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
        name,
        email,
        role,
        created: now,
        lastLogin: null,
        status: "Active",
        permissions: role === "admin"
          ? ["view-devices", "control-devices", "view-history", "manage-scenes", "manage-users", "system-settings"]
          : permissions,
        passwordChanged: false,
        online: false,
        password
      };

      users.push(newUser);
      storage.set("smartHomeUsers", users);

      $("#create-user-form").reset();
      $$('.permission-checkbox').forEach(cb => cb.classList.remove("checked"));

      closeModal("create-user-modal");
      setTimeout(() => {
        openModal("manage-users-modal");
        renderUsersList();
      }, 300);

      toast(`User ${name} created successfully!`, "success", 4000);
    });

    // Fix for permission checkboxes
    function initPermissionCheckboxes() {
      $$('.permission-checkbox').forEach(cb => {
        cb.addEventListener("click", function() {
          // Don't allow clicking if admin role is selected
          const form = this.closest('form');
          if (!form) return;
          
          const roleSelect = form.querySelector('select[id*="role"]');
          if (roleSelect && roleSelect.value === "admin") return;
          
          this.classList.toggle("checked");
        });
      });
    }

    $("#new-user-role").addEventListener("change", function() {
      const checkboxes = $$('.permission-checkbox', $("#create-user-modal"));
      if (this.value === "admin") {
        checkboxes.forEach(cb => cb.classList.add("checked"));
      } else {
        checkboxes.forEach(cb => cb.classList.remove("checked"));
      }
    });

    /* =========================
       SOS Modal
       ========================= */
    $("#sos-btn").addEventListener("click", () => openModal("sos-modal"));
    $("#sos-close-btn").addEventListener("click", () => closeModal("sos-modal"));

    $("#call-ambulance-btn").addEventListener("click", () => {
      closeModal("sos-modal");
      toast("üöë Ambulance called! Emergency services are on their way.", "emergency", 10000);
    });

    $("#call-civil-protection-btn").addEventListener("click", () => {
      closeModal("sos-modal");
      toast("üöí Civil Protection called! Fire and rescue services are on their way.", "emergency", 10000);
    });

    /* =========================
       Visualization Modal
       ========================= */
    function updateVisualizationData() {
      const state = storage.get("smartHomeState", {});
      
      // Temperature
      const temp = state.temp || 21;
      $("#vis-temperature").textContent = `${temp} ¬∞C`;
      
      // Living Room Lights
      const livingLights = state["living-light"] !== false;
      $("#vis-living-lights").textContent = livingLights ? "ON" : "OFF";
      
      // Kitchen Lights
      const kitchenLights = state["kitchen-light"] !== false;
      $("#vis-kitchen-lights").textContent = kitchenLights ? "ON" : "OFF";
      
      // Bedroom Lighting
      const bedroomLights = state["bedroom-light"] || false;
      $("#vis-bedroom-lights").textContent = bedroomLights ? "ON" : "OFF";
      
      // Main Door
      const door = state["garage-door"] || false;
      $("#vis-door").textContent = door ? "OPEN" : "CLOSED";
      
      // Gas Detection
      const coSensor = state["co-sensor"] !== false;
      const methaneSensor = state["methane-sensor"] !== false;
      const gasStatus = (coSensor && methaneSensor) ? "NORMAL" : "ALERT";
      $("#vis-gas").textContent = gasStatus;
      
      // Update status classes
      $("#vis-living-lights").parentElement.querySelector(".visualization-status").className = 
        `visualization-status ${livingLights ? "on" : "off"}`;
      $("#vis-kitchen-lights").parentElement.querySelector(".visualization-status").className = 
        `visualization-status ${kitchenLights ? "on" : "off"}`;
      $("#vis-bedroom-lights").parentElement.querySelector(".visualization-status").className = 
        `visualization-status ${bedroomLights ? "on" : "off"}`;
      $("#vis-door").parentElement.querySelector(".visualization-status").className = 
        `visualization-status ${door ? "off" : "on"}`;
      $("#vis-gas").parentElement.querySelector(".visualization-status").className = 
        `visualization-status ${gasStatus === "NORMAL" ? "on" : "off"}`;
    }

    $("#visualization-btn").addEventListener("click", () => {
      openModal("visualization-modal");
      updateVisualizationData();
      toast("Opening Visualization...", "info");
    });

    $("#visualization-close-btn").addEventListener("click", () => closeModal("visualization-modal"));
    
    $("#refresh-visualization").addEventListener("click", () => {
      updateVisualizationData();
      toast("Visualization data refreshed!", "success", 1500);
    });

    /* =========================
       Settings
       ========================= */
    const settingsModalOverlay = $("#settings-modal-overlay");
    const settingsBtn = $("#settings-btn");
    const modalCloseBtn = $("#modal-close-btn");
    const passwordForm = $("#change-password-form");
    const passwordError = $("#password-error");

    function openSettingsModal() {
      openModal("settings-modal-overlay");
      toast("Opening Settings...", "info");
    }
    function closeSettingsModal() {
      closeModal("settings-modal-overlay");
      passwordError.style.display = "none";
    }

    applyTheme(true);

    settingsBtn?.addEventListener("click", openSettingsModal);
    modalCloseBtn?.addEventListener("click", closeSettingsModal);

    settingsModalOverlay?.addEventListener("click", (e) => {
      if (e.target === settingsModalOverlay) closeSettingsModal();
    });

    $$(".theme-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const newTheme = btn.dataset.themeVal;
        applyTheme(false, newTheme);
        toast(`Theme set to ${newTheme.charAt(0).toUpperCase() + newTheme.slice(1)}`, "info", 1500);
      });
    });

    passwordForm?.addEventListener("submit", (e) => {
      e.preventDefault();
      passwordError.style.display = "none";

      const newPwd = $("#new-password").value.trim();
      const confirmPwd = $("#confirm-password").value.trim();

      if (newPwd.length < 6) {
        passwordError.textContent = "Password must be at least 6 characters long.";
        passwordError.style.display = "block";
        toast("Password change failed.", "danger", 3000);
        return;
      }
      if (newPwd !== confirmPwd) {
        passwordError.textContent = "Passwords do not match.";
        passwordError.style.display = "block";
        toast("Password change failed.", "danger", 3000);
        return;
      }

      currentUser.password = newPwd;
      currentUser.passwordChanged = true;

      const idx = users.findIndex(u => u.id === currentUser.id);
      if (idx !== -1) {
        users[idx].password = newPwd;
        users[idx].passwordChanged = true;
        storage.set("smartHomeUsers", users);
      }

      $("#new-password").value = "";
      $("#confirm-password").value = "";
      toast("Password successfully updated!", "success", 4000);
    });

    // Delete current account
    $("#delete-account-btn").addEventListener("click", () => {
      const ok = confirm(`Delete your account (${currentUser.email})?\n\nThis action cannot be undone in this demo.`);
      if (!ok) return;

      // Remove user
      users = users.filter(u => u.id !== currentUser.id);
      storage.set("smartHomeUsers", users);

      // Logout
      storage.del("smartHomeLogged");
      storage.del("smartHomeLastEmail");

      toast("Account deleted. You have been logged out.", "success", 4000);
      closeAllModals();

      // If no users left, restore defaults
      if (users.length === 0) {
        users = DEFAULT_USERS;
        storage.set("smartHomeUsers", users);
      }

      currentUser = users[0];
      showLogin();
    });

    /* =========================
       Logout
       ========================= */
    $("#logout-btn").addEventListener("click", () => {
      const idx = users.findIndex(u => u.id === currentUser.id);
      if (idx !== -1) {
        users[idx].online = false;
        storage.set("smartHomeUsers", users);
      }

      storage.del("smartHomeLogged");
      storage.del("smartHomeLastEmail");

      toast("Logged out.", "info");
      showLogin();
      closeAllModals();
    });

    /* =========================
       Views & Persistent States
       ========================= */
    const state = storage.get("smartHomeState", {});
    function getState(id, fallback) { return (id in state) ? state[id] : fallback; }
    function setState(id, value) { state[id] = value; storage.set("smartHomeState", state); }

    const views = {
        lights: [
            { id: "living-light", label: "Living Room Lights", sub: "", type: "toggle", defaultOn: true },
            { id: "kitchen-light", label: "Kitchen Lights", sub: "", type: "toggle", defaultOn: true },
            { id: "bedroom-light", label: "Bedroom Lighting", sub: "", type: "toggle", defaultOn: false },
        ],
        climate: [
            { id: "temp", label: "Main Thermostat", sub: "Current setting: {{value}} ¬∞C", type: "slider", min: 16, max: 28, value: 21 },
            { id: "eco-mode", label: "Eco Mode", sub: "Automatic night reduction", type: "toggle", defaultOn: true },
        ],
        gas: [
            { id: "co-sensor", label: "Carbon Monoxide (CO) Sensor", sub: "Status: Normal", type: "toggle", defaultOn: true },
            { id: "methane-sensor", label: "Methane Sensor (Kitchen)", sub: "Status: Normal", type: "toggle", defaultOn: true },
        ],
        garage: [
            { id: "garage-door", label: "Home Door", sub: "Door {{doorState}}", type: "toggle", defaultOn: false },
        ],
        movement: [
            { id: "motion-outdoor", label: "Outdoor Area Sensor", sub: "Alerts on large movement", type: "toggle", defaultOn: true },
            { id: "door-vibration", label: "Door Vibration Sensor", sub: "Off when home", type: "toggle", defaultOn: false },
            { id: "sensitivity", label: "System Sensitivity", sub: "Set to {{value}}", type: "slider", min: 1, max: 10, value: 7 },
        ],
    };

    const phoneList = $("#phone-list");
    const phoneSearch = $("#phone-search");
    let currentView = "lights";
    const scheduledTimers = [];
    let energyMeterInterval = null;

    // Map device labels to hotspot IDs
    const roomToHotspotMap = {
        "Living Room Lights": "hp-living",
        "Kitchen Lights": "hp-kitchen", 
        "Bedroom Lighting": "hp-bedroom"
    };

    // Function to update gas bubble status
    function updateGasBubbleStatus() {
      const gasBubble = document.querySelector('.bubble-card[data-target="gas"]');
      if (!gasBubble) return;
      
      const coSensor = getState("co-sensor", true);
      const methaneSensor = getState("methane-sensor", true);
      
      const bubbleSub = gasBubble.querySelector('.bubble-sub');
      if (bubbleSub) {
        const allNormal = coSensor && methaneSensor;
        bubbleSub.textContent = allNormal ? "Normal" : "Alert";
      }
    }

    // Function to update architectural hotspot when phone toggle changes
    function syncLightWithHotspot(deviceLabel, isOn) {
        const hotspotId = roomToHotspotMap[deviceLabel];
        if (!hotspotId) return;
        
        const hotspot = document.getElementById(hotspotId);
        if (!hotspot) return;
        
        // Update the hotspot visual state
        hotspot.setAttribute('data-active', isOn);
        hotspot.classList.toggle('is-active', isOn);
        
        // Update the emoji for better visual feedback
        if (isOn) {
            hotspot.innerHTML = "üí°"; // Light on emoji
            hotspot.style.backgroundColor = "var(--accent-yellow)";
            hotspot.style.boxShadow = "0 0 15px var(--accent-yellow), 0 0 30px rgba(233, 212, 77, 0.6)";
            hotspot.style.transform = "scale(1.2)";
        } else {
            hotspot.innerHTML = "üí°"; // Same emoji but dimmed
            hotspot.style.backgroundColor = "var(--bg-panel)";
            hotspot.style.boxShadow = "none";
            hotspot.style.transform = "scale(1)";
        }
    }

    // Helper function to map hotspot IDs back to device labels
    function getDeviceLabelFromHotspotId(hotspotId) {
        const reverseMap = {
            "hp-living": "Living Room Lights",
            "hp-kitchen": "Kitchen Lights", 
            "hp-bedroom": "Bedroom Lighting"
        };
        return reverseMap[hotspotId];
    }

    /* =========================
       DOOR SYNCHRONIZATION
       ========================= */
    function syncDoor(isOpen) {
        const doorLeaf = document.getElementById('door-leaf');
        if (doorLeaf) {
            doorLeaf.setAttribute('data-open', isOpen);
        }
        
        // Update door state in storage
        setState("garage-door", isOpen);
        
        // Update bubble card subtitle
        const doorBubble = document.querySelector('.bubble-card[data-target="garage"]');
        if (doorBubble) {
            const bubbleSub = doorBubble.querySelector('.bubble-sub');
            if (bubbleSub) {
                bubbleSub.textContent = `Door ${isOpen ? 'open' : 'closed'}`;
            }
        }
        
        // Update phone toggle if in garage view
        if (currentView === "garage") {
            const doorCard = document.querySelector('.phone-card[data-search*="home door"]');
            if (doorCard) {
                const doorToggle = doorCard.querySelector('.toggle');
                if (doorToggle) {
                    const newState = String(isOpen);
                    doorToggle.setAttribute("data-on", newState);
                    doorToggle.setAttribute("aria-checked", newState);
                    
                    // Update door subtitle in phone card
                    const sub = doorCard.querySelector('.phone-card-sub');
                    if (sub) {
                        sub.textContent = `Door ${isOpen ? 'open' : 'closed'}`;
                    }
                }
            }
        }
        
        // Update visualization modal if open
        if (document.getElementById("visualization-modal").style.display === "flex") {
            updateVisualizationData();
        }
        
        // Show toast notification
        toast(`Home door ${isOpen ? 'opened' : 'closed'}`, "info", 1500);
    }

    function createCard(item) {
        const card = document.createElement("div");
        card.className = "phone-card";
        card.tabIndex = 0;

        const main = document.createElement("div");
        main.className = "phone-card-main";

        const valueForSub = (item.type === "slider") ? getState(item.id, item.value) : null;
        let subText = item.sub ? item.sub.replace("{{value}}", valueForSub ?? "") : "";

        // Special handling for door state
        if (item.id === "garage-door") {
            const doorState = getState(item.id, item.defaultOn) ? "open" : "closed";
            subText = item.sub.replace("{{doorState}}", doorState);
        }

        const label = document.createElement("div");
        label.className = "phone-card-label";
        label.textContent = item.label;

        const sub = document.createElement("div");
        sub.className = "phone-card-sub";
        sub.innerHTML = subText;

        main.appendChild(label);
        main.appendChild(sub);

        const right = document.createElement("div");

        if (item.type === "toggle") {
            const initial = getState(item.id, item.defaultOn === true);
            const toggle = document.createElement("button");
            toggle.type = "button";
            toggle.className = "toggle";
            toggle.setAttribute("data-on", String(initial));
            toggle.setAttribute("role", "switch");
            toggle.setAttribute("aria-checked", String(initial));
            toggle.setAttribute("aria-label", item.label);
            toggle.innerHTML = `<span class="toggle-circle"></span>`;
            
            // Special handling for door toggle
            if (item.id === "garage-door") {
                const doorState = initial ? "open" : "closed";
                sub.innerHTML = item.sub.replace("{{doorState}}", doorState);
            } else if (roomToHotspotMap[item.label]) {
                // Set initial hotspot state for lights
                syncLightWithHotspot(item.label, initial);
            } else if (item.id.includes("sensor")) {
                // Update gas bubble status
                updateGasBubbleStatus();
            }
            
            const setToggle = (on) => {
                toggle.setAttribute("data-on", String(on));
                toggle.setAttribute("aria-checked", String(on));
                setState(item.id, on);
                
                // Special handling for door
                if (item.id === "garage-door") {
                    syncDoor(on);
                    // Update subtitle
                    const doorState = on ? "open" : "closed";
                    sub.innerHTML = item.sub.replace("{{doorState}}", doorState);
                } else if (roomToHotspotMap[item.label]) {
                    // Sync with architectural hotspot for lights
                    syncLightWithHotspot(item.label, on);
                } else if (item.id.includes("sensor")) {
                    // Update gas bubble status
                    updateGasBubbleStatus();
                    // Update visualization
                    updateVisualizationData();
                }
            };
            
            toggle.addEventListener("click", () => {
                const newState = !(toggle.getAttribute("data-on") === "true");
                setToggle(newState);
                // Show toast for door
                if (item.id === "garage-door") {
                    toast(`Home door ${newState ? 'opened' : 'closed'}`, "info", 1500);
                } else if (item.id.includes("sensor")) {
                    toast(`${item.label} ${newState ? 'activated' : 'deactivated'}`, "info", 1500);
                }
            });
            
            toggle.addEventListener("keydown", (e) => {
                if (e.key === " " || e.key === "Enter") { 
                    e.preventDefault(); 
                    toggle.click(); 
                }
            });
            right.appendChild(toggle);
        }

        if (item.type === "slider") {
            const slider = document.createElement("input");
            slider.type = "range";
            slider.className = "slider";
            slider.min = item.min;
            slider.max = item.max;
            slider.value = getState(item.id, item.value);
            slider.setAttribute("aria-label", item.label);
            slider.addEventListener("input", () => {
                sub.innerHTML = item.sub.replace("{{value}}", slider.value);
            });
            slider.addEventListener("change", () => {
                setState(item.id, Number(slider.value));
                toast(`${item.label}: ${slider.value}`, "info", 1500);
            });
            right.style.minWidth = "90px";
            right.appendChild(slider);
            sub.innerHTML = item.sub.replace("{{value}}", slider.value);
        }

        if (item.type === "button") {
            const btn = document.createElement("button");
            btn.type = "button"; btn.className = "inline-btn";
            btn.textContent = item.buttonLabel;
            btn.addEventListener("click", () => triggerScenario(item.label));
            right.appendChild(btn);

            const plan = document.createElement("button");
            plan.type = "button"; plan.className = "link-btn";
            plan.textContent = "‚è± Schedule";
            plan.addEventListener("click", () => scheduleScenario(item.label));
            right.appendChild(plan);
        }

        if (item.type === "meter") {
            const meter = document.createElement("div");
            meter.className = "meter";
            const bar = document.createElement("div");
            bar.className = "meter-bar";
            meter.appendChild(bar);
            right.style.minWidth = "130px";
            right.appendChild(meter);

            const setVal = (v) => {
                const val = Math.max(0, Math.min(100, v));
                bar.style.width = val + "%";
                sub.textContent = `Load: ${val.toFixed(0)}%`;
                setState(item.id, val);
            };
            setVal(getState(item.id, item.value));

            if (energyMeterInterval) clearInterval(energyMeterInterval);
            let dir = 1;
            energyMeterInterval = setInterval(() => {
                let cur = getState(item.id, item.value);
                cur += dir * (Math.random() * 2);
                if (cur > 85) dir = -1;
                if (cur < 15) dir = 1;
                setVal(cur);
            }, 2500);
        }

        card.appendChild(main);
        card.appendChild(right);

        card.dataset.search = (item.label + " " + (sub.textContent || sub.innerText)).toLowerCase();
        return card;
    }

    function renderView(viewKey) {
        currentView = viewKey;
        if (energyMeterInterval) {
            clearInterval(energyMeterInterval);
            energyMeterInterval = null;
        }

        const items = views[viewKey] || [];
        phoneList.innerHTML = "";
        items.forEach(item => phoneList.appendChild(createCard(item)));
        applySearchFilter();
        
        // Update bubble card for current view
        $$(".bubble-card").forEach(b => {
            b.setAttribute("aria-pressed", b.getAttribute("data-target") === viewKey ? "true" : "false");
        });
    }

    function applySearchFilter() {
        const q = phoneSearch.value.trim().toLowerCase();
        $$(".phone-card", phoneList).forEach(card => {
            card.style.display = q && !card.dataset.search.includes(q) ? "none" : "";
        });
    }

    phoneSearch.addEventListener("input", applySearchFilter);

    function triggerScenario(label) {
        if (label.includes("Good Night")) {
            setState("living-light", false);
            setState("kitchen-light", false);
            setState("co-sensor", true);
            toast("‚ÄúGood Night‚Äù Scene executed: lights off, gas detection active.", "success", 4000);
        } else if (label.includes("Vacation")) {
            setState("notification", true);
            setState("co-sensor", true);
            toast("‚ÄúVacation‚Äù Scene: presence simulation and enhanced security.", "success", 4000);
        } else {
            toast(`"${label}" Scene triggered ‚úÖ`, "success");
        }
        renderView(currentView);
    }

    function scheduleScenario(label) {
        const minutes = prompt("In how many minutes should this scene be executed?", "2");
        if (!minutes) return;
        const m = Number(minutes);
        if (Number.isNaN(m) || m <= 0) {
            toast("Invalid value.", "danger");
            return;
        }
        const when = new Date(Date.now() + m * 60 * 1000);
        toast(`"${label}" scheduled for ${when.toLocaleTimeString()}`, "info", 5000);
        const t = setTimeout(() => {
            triggerScenario(label);
            const idx = scheduledTimers.findIndex(x => x.t === t);
            if (idx >= 0) scheduledTimers.splice(idx, 1);
        }, m * 60 * 1000);
        scheduledTimers.push({ label, when, t });
    }

    /* Bubble navigation */
    renderView("lights");

    $$(".bubble-card").forEach(btn => {
        btn.addEventListener("click", () => {
            const target = btn.getAttribute("data-target");
            if (btn.classList.contains("is-disabled")) return;
            renderView(target);
        });
        btn.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                btn.click();
            }
        });
    });

    /* Keyboard shortcut: Ctrl/Cmd + K -> focus search */
    window.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
            e.preventDefault();
            phoneSearch.focus();
        }
    });

    /* Click on card = toggle if available */
    document.addEventListener("click", (e) => {
        const card = e.target.closest(".phone-card");
        if (!card) return;
        const toggle = card.querySelector(".toggle");
        if (toggle && (e.target === card || e.target.closest(".phone-card-main"))) {
            toggle.click();
        }
    });

    // Initialize user data
    if (isLogged) {
        updateUserDisplay();
    }

    // Add click handler for architectural hotspots to also control phone toggles
    document.addEventListener('click', (e) => {
        const hotspot = e.target.closest('.hotspot');
        if (hotspot) {
            const hotspotId = hotspot.id;
            const deviceLabel = getDeviceLabelFromHotspotId(hotspotId);
            
            if (deviceLabel) {
                // Find and toggle the corresponding phone toggle
                const phoneCards = document.querySelectorAll('.phone-card');
                phoneCards.forEach(card => {
                    const labelElem = card.querySelector('.phone-card-label');
                    if (labelElem && labelElem.textContent === deviceLabel) {
                        const toggle = card.querySelector('.toggle');
                        if (toggle) {
                            toggle.click(); // This will trigger all the sync logic
                        }
                    }
                });
            }
        }
        
        // Door control
        const doorTrigger = e.target.closest('#main-door-trigger') || e.target.closest('.door-leaf');
        if (doorTrigger) {
            const leaf = document.getElementById('door-leaf');
            const currentState = leaf.getAttribute('data-open') === 'true';
            const newState = !currentState;
            syncDoor(newState);
        }
    });

    // Initialize all hotspots based on current device states
    function initializeHotspots() {
        const lightsView = views.lights;
        lightsView.forEach(device => {
            const currentState = getState(device.id, device.defaultOn);
            syncLightWithHotspot(device.label, currentState);
        });
        
        // Initialize door state
        const doorState = getState("garage-door", false);
        syncDoor(doorState);
        
        // Initialize bubble card subtitle for door
        const doorBubble = document.querySelector('.bubble-card[data-target="garage"]');
        if (doorBubble) {
            const bubbleSub = doorBubble.querySelector('.bubble-sub');
            if (bubbleSub) {
                bubbleSub.textContent = `Door ${doorState ? 'open' : 'closed'}`;
            }
        }

 
    
// On √©coute les clics sur TOUTE la page
    document.addEventListener('click', function(e) {
        
        // 1. Est-ce qu'on a cliqu√© sur une checkbox de permission ?
        if (e.target && e.target.classList.contains('permission-checkbox')) {
            
            // V√©rification : Si le r√¥le est "Admin", on interdit le changement manuel
            const roleSelect = document.getElementById('new-user-role');
            if (roleSelect && roleSelect.value === 'admin') {
                return; // On ne fait rien
            }

            // Action : On bascule l'√©tat "checked"
            const box = e.target;
            box.classList.toggle('checked');

            // Mise √† jour visuelle forc√©e
            if (box.classList.contains('checked')) {
                box.style.backgroundColor = '#2ec4b6'; // Vert
                box.style.borderColor = '#2ec4b6';
                box.style.color = 'white';
                box.textContent = '‚úì';
            } else {
                box.style.backgroundColor = 'transparent';
                box.style.borderColor = '#ccc';
                box.textContent = '';
            }
        }
    });

    // 2. Gestion du changement de r√¥le (Admin = tout coch√©)
    const roleSelect = document.getElementById('new-user-role');
    if(roleSelect) {
        roleSelect.addEventListener('change', function() {
            const boxes = document.querySelectorAll('.permission-checkbox');
            
            if (this.value === 'admin') {
                // Si Admin : On coche tout et on verrouille
                boxes.forEach(box => {
                    box.classList.add('checked');
                    box.style.backgroundColor = '#2ec4b6';
                    box.style.color = 'white';
                    box.textContent = '‚úì';
                    box.style.opacity = '0.5';       // Gris√©
                    box.style.cursor = 'not-allowed'; // Interdit
                });
            } else {
                // Si User : On d√©verrouille (et on d√©coche pour laisser le choix)
                boxes.forEach(box => {
                    box.classList.remove('checked');
                    box.style.backgroundColor = 'transparent';
                    box.textContent = '';
                    box.style.opacity = '1';
                    box.style.cursor = 'pointer';
                });
            }
        });
    }

    /* =============================================================
       GESTION DU BOUTON "CR√âER UN UTILISATEUR"
       ============================================================= */
    const openCreateBtn = document.getElementById('create-user-btn');
    if (openCreateBtn) {
        openCreateBtn.addEventListener('click', function() {
            // Fermer le modal info
            const infoModal = document.getElementById('user-info-modal');
            if(infoModal) {
                infoModal.style.display = 'none';
                infoModal.classList.remove('open');
            }

            // Ouvrir le modal cr√©ation
            const createModal = document.getElementById('create-user-modal');
            if(createModal) {
                createModal.style.display = 'flex';
                setTimeout(() => createModal.classList.add('open'), 10);
                
                // Reset du formulaire
                document.getElementById('create-user-form').reset();
                
                // Reset visuel des cases (important)
                document.querySelectorAll('.permission-checkbox').forEach(box => {
                    box.classList.remove('checked');
                    box.style.backgroundColor = 'transparent';
                    box.textContent = '';
                    box.style.opacity = '1';
                    box.style.cursor = 'pointer';
                });
            }
        });
    }

    /* =============================================================
       ENVOI DU FORMULAIRE (Code que vous aviez d√©j√†)
       ============================================================= */
    const createForm = document.getElementById('create-user-form');
    if (createForm) {
        createForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // ... (Gardez votre logique d'envoi fetch ici) ...
            // Rappel : R√©cup√©rer les permissions comme √ßa :
            const perms = [];
            document.querySelectorAll('.permission-checkbox.checked').forEach(box => {
                perms.push(box.getAttribute('data-permission'));
            });
            
            // ... suite du fetch ...
        });
    }
    
    // Fermeture des modals
    document.querySelectorAll('.modal-close-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal-overlay');
            modal.classList.remove('open');
            setTimeout(() => modal.style.display = 'none', 300);
        });
    });
    // Event Listener for the "Create New User" button (To open modal)
    
    if (openCreateBtn) {
        openCreateBtn.addEventListener('click', function() {
            // 1. Close User Info Modal if open
            const infoModal = document.getElementById('user-info-modal');
            if(infoModal) {
                infoModal.style.display = 'none';
                infoModal.classList.remove('open');
            }

            // 2. Open Create User Modal
            const createModal = document.getElementById('create-user-modal');
            if(createModal) {
                createModal.style.display = 'flex';
                setTimeout(() => createModal.classList.add('open'), 10);
                
                // 3. IMPORTANT: Reset form and Initialize Checkboxes
                document.getElementById('create-user-form').reset();
                initCheckboxes(); 
            }
        });
    }


    /* --- 2. SEND DATA (SUBMIT BUTTON) --- */
    
    if (createForm) {
        createForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            const name = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const role = document.getElementById('new-user-role').value;

            // Get selected permissions
            const perms = [];
            document.querySelectorAll('.permission-checkbox.checked').forEach(box => {
                // Make sure your HTML has data-permission="something"
                const permCode = box.getAttribute('data-permission') || box.getAttribute('data-perm');
                if(permCode) perms.push(permCode);
            });

            // Send to Django
           try {
                const response = await fetch('/api/register/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') // Ensure getCookie exists
                    },
                    body: JSON.stringify({
                        name: name,
                        email: email,
                        password: password,
                        role: role,
                        permissions: perms // Sending the array
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert("User successfully created in SQL Database!");
                    
                    // Close Modal
                    const modal = document.getElementById('create-user-modal');
                    modal.classList.remove('open');
                    setTimeout(() => modal.style.display = 'none', 300);
                    
                    createForm.reset();
                } else {
                    alert("Error: " + result.message);
                }

            } catch (error) {
                console.error("Error:", error);
                alert("Connection failed. Is the Python server running?");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });
    }

    // Helper: Close Modals on 'X' click
    document.querySelectorAll('.modal-close-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal-overlay');
            modal.classList.remove('open');
            setTimeout(() => modal.style.display = 'none', 300);
        });
    });
        // Initialize gas bubble status
        updateGasBubbleStatus();
    }
    // 1. Fonction qui force l'activation des boutons
    function setupCheckboxesForce() {
        console.log("üîÑ Initialisation des checkboxes...");
        
        const boxes = document.querySelectorAll('.permission-checkbox');
        
        if (boxes.length === 0) {
            console.error("‚ö†Ô∏è AUCUNE checkbox trouv√©e ! V√©rifiez que la classe est bien 'permission-checkbox' dans le HTML.");
            return;
        }

        boxes.forEach(box => {
            // Clone pour nettoyer les vieux listeners bugg√©s
            const newBox = box.cloneNode(true);
            box.parentNode.replaceChild(newBox, box);

            // Ajout du listener propre
            newBox.addEventListener('click', function(e) {
                console.log("‚úÖ Click d√©tect√© sur : ", this);
                
                // Gestion Admin (Bloqu√©)
                const role = document.getElementById('new-user-role');
                if (role && role.value === 'admin') {
                    console.log("üîí Bloqu√© car Admin");
                    return; 
                }

                // Bascule visuelle
                this.classList.toggle('checked');

                if (this.classList.contains('checked')) {
                    this.style.backgroundColor = '#2ec4b6';
                    this.style.color = 'white';
                    this.textContent = '‚úì';
                } else {
                    this.style.backgroundColor = 'transparent';
                    this.textContent = '';
                }
            });
        });
        console.log(`‚úÖ ${boxes.length} checkboxes pr√™tes.`);
    }

    // 2. Attacher au bouton "Create User"
    const btnCreate = document.getElementById('create-user-btn');
    if (btnCreate) {
        btnCreate.addEventListener('click', function() {
            // Ouvrir le modal
            document.getElementById('user-info-modal').style.display = 'none';
            const modal = document.getElementById('create-user-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('open'), 10);

            // ‚ö†Ô∏è ATTENDRE 100ms QUE LE MODAL SOIT AFFICH√â AVANT D'ACTIVER LES BOUTONS
            setTimeout(setupCheckboxesForce, 100); 
        });
    } else {
        console.error("‚ùå Bouton 'create-user-btn' introuvable !");
    }

    // 3. Gestion Fermeture Modal
    document.getElementById('create-user-close-btn').addEventListener('click', function() {
        document.getElementById('create-user-modal').style.display = 'none';
    });

    /* =========================
       ENVOI DU FORMULAIRE (REGISTER)
       ========================= */
    document.getElementById('create-user-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const btn = this.querySelector('button[type="submit"]');
        btn.innerText = "Envoi...";

        // Collecte des permissions
        const perms = [];
        document.querySelectorAll('.permission-checkbox.checked').forEach(b => {
            perms.push(b.getAttribute('data-permission'));
        });

        console.log("üì§ Envoi des permissions :", perms);

        try {
            const response = await fetch('/api/register/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    name: document.getElementById('new-user-name').value,
                    email: document.getElementById('new-user-email').value,
                    password: document.getElementById('new-user-password').value,
                    role: document.getElementById('new-user-role').value,
                    permissions: perms
                })
            });
            
            const res = await response.json();
            if(res.status === 'success') {
                alert("User created!");
                document.getElementById('create-user-modal').style.display = 'none';
                this.reset();
            } else {
                alert("Error: " + res.message);
            }
        } catch(err) {
            console.error(err);
            alert("Erreur serveur.");
        } finally {
            btn.innerText = "Create Account";
        }
    });

    // Call initialization when the app loads
    if (isLogged) {
        setTimeout(() => {
            initializeHotspots();
            initPermissionCheckboxes();
        }, 500); // Small delay to ensure DOM is ready
    }
  /* =========================================
   HARDWARE CONTROL (LIGHTS & DOORS)
   ========================================= */
document.addEventListener('click', function(e) {
    // Check if the clicked element is a toggle switch
    if (e.target && e.target.closest('.toggle-switch')) {
        
        const toggle = e.target.closest('.toggle-switch');
        const deviceId = toggle.getAttribute('id') || toggle.getAttribute('data-id');
        
        // 1. Toggle visual state immediately (UI)
        toggle.classList.toggle('active');
        const isActive = toggle.classList.contains('active');

        console.log(`üñ±Ô∏è Clicked ${deviceId}. New State: ${isActive}`);

        // 2. Send Command to Django Server
        fetch('/api/set_state/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken') // Function must exist in your script
            },
            body: JSON.stringify({
                id: deviceId,
                value: isActive
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log("‚úÖ Server Response:", data);
            if(data.status !== 'success') {
                alert("Server Error: " + data.message);
                // Revert visual state if error
                toggle.classList.toggle('active');
            }
        })
        .catch(error => {
            console.error("‚ùå Network Error:", error);
        });
    }
});



document.addEventListener('DOMContentLoaded', function() {

    // --- 1. SETUP PERMISSION CLICKS (Restored Visuals) ---
    // We listen for clicks on the whole item (Text + Box)
    const permItems = document.querySelectorAll('.permission-item');
    
    permItems.forEach(item => {
        item.addEventListener('click', function() {
            // Find the little square inside this item
            const checkbox = this.querySelector('.permission-checkbox');
            
            // Toggle the 'active' class (This should show your checkmark)
            checkbox.classList.toggle('active');
            
            // OPTIONAL: Force Green color just in case CSS is missing
            if (checkbox.classList.contains('active')) {
                checkbox.style.backgroundColor = '#4CAF50'; // Green
                checkbox.style.borderColor = '#4CAF50';
            } else {
                checkbox.style.backgroundColor = ''; // Reset to default
                checkbox.style.borderColor = '';
            }
        });
    });

    // --- 2. SETUP CREATE BUTTON ---
    const btnCreate = document.getElementById('btn-confirm-create');

    if (btnCreate) {
        btnCreate.addEventListener('click', function() {
            
            // A. Get Values (Using the UNIQUE IDs)
            const nameVal = document.getElementById('unique-name').value;
            const emailVal = document.getElementById('unique-email').value;
            const passVal = document.getElementById('unique-password').value;
            const roleVal = document.getElementById('unique-role').value;

            // B. Validation
            if (!nameVal || !emailVal) {
                alert("‚ö†Ô∏è Please fill in Name and Email.");
                return;
            }

            // C. Collect Permissions (Updated for Grid)
            let selectedPerms = [];
            // We look for items where the checkbox inside has the 'active' class
            document.querySelectorAll('.permission-item').forEach(item => {
                const checkbox = item.querySelector('.permission-checkbox');
                if (checkbox.classList.contains('active')) {
                    selectedPerms.push(item.getAttribute('data-val'));
                }
            });

            console.log("üöÄ Sending:", nameVal, selectedPerms);

            // D. Send to Django
            fetch('/api/register/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    name: nameVal,
                    email: emailVal,
                    password: passVal,
                    role: roleVal,
                    permissions: selectedPerms
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert("‚úÖ User Created!");
                    document.getElementById('create-user-modal').style.display = 'none';
                    // Reset Checkboxes
                    document.querySelectorAll('.permission-checkbox').forEach(cb => {
                        cb.classList.remove('active');
                        cb.style.backgroundColor = '';
                    });
                } else {
                    alert("‚ùå Server Error: " + data.message);
                }
            })
            .catch(err => alert("Network Error: " + err));
        });
    }
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
// 1. Handle Permission Button Clicks (Toggle Green)
document.querySelectorAll('.perm-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        this.classList.toggle('active');
    });
});

// 2. Handle "Create User" Click
const finalCreateBtn = document.getElementById('btn-final-create');
if (finalCreateBtn) {
    finalCreateBtn.addEventListener('click', function() {
        
        // Get values from the UNIQUE IDs
        const nameVal = document.getElementById('final-name').value.trim();
        const emailVal = document.getElementById('final-email').value.trim();
        const passVal = document.getElementById('final-password').value.trim();
        const roleVal = document.getElementById('final-role').value;

        // Security Check
        if (!nameVal || !emailVal || !passVal) {
            alert("‚ö†Ô∏è Please fill in all fields: Name, Email, and Password.");
            return;
        }

        // Collect Green Permissions
        let selectedPerms = [];
        document.querySelectorAll('.perm-btn.active').forEach(btn => {
            selectedPerms.push(btn.getAttribute('data-val'));
        });

        console.log("üöÄ Sending Data:", { name: nameVal, email: emailVal, perms: selectedPerms });

        // Send to Django
        fetch('/api/register/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: nameVal,
                email: emailVal,
                password: passVal,
                role: roleVal,
                permissions: selectedPerms
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                alert("‚úÖ User Created Successfully!");
                // Close modal and reset
                document.getElementById('create-user-modal').style.display = 'none';
                document.getElementById('create-user-modal').classList.remove('open');
                
                // Clear inputs
                document.getElementById('final-name').value = "";
                document.getElementById('final-email').value = "";
                document.getElementById('final-password').value = "";
                document.querySelectorAll('.perm-btn').forEach(b => b.classList.remove('active'));
            } else {
                alert("‚ùå Error: " + data.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert("Network Error: check console.");
        });
    });
}
document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. BYPASS LOGIC: LISTENS ONLY TO THE NEW BUTTON ---
    const realBtn = document.getElementById('btn-save-to-db');

    if (realBtn) {
        realBtn.addEventListener('click', function() {
            console.log("üöÄ Starting Database Creation...");

            // A. GRAB DATA (Using the IDs currently in your file)
            // Note: Your file uses 'new-user-name', not 'final-name'
            const nameInput = document.getElementById('new-user-name');
            const emailInput = document.getElementById('new-user-email');
            const passInput = document.getElementById('new-user-password');
            const roleInput = document.getElementById('new-user-role');

            // Safety Check
            if (!nameInput || !emailInput) {
                alert("CRITICAL: Inputs not found. Check HTML IDs.");
                return;
            }

            const nameVal = nameInput.value.trim();
            const emailVal = emailInput.value.trim();
            const passVal = passInput.value.trim();
            const roleVal = roleInput.value;

            // B. STOP IF EMPTY
            if (nameVal === "" || emailVal === "") {
                alert("‚ö†Ô∏è STOP: Name or Email is empty. Please type something.");
                return;
            }

            // C. COLLECT PERMISSIONS
            const perms = [];
            document.querySelectorAll('.permission-checkbox.checked').forEach(box => {
                const p = box.getAttribute('data-permission');
                if (p) perms.push(p);
            });

            // D. SEND TO DJANGO
            const btnText = realBtn.innerText;
            realBtn.innerText = "Saving...";
            
            fetch('/api/register/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    name: nameVal,
                    email: emailVal,
                    password: passVal,
                    role: roleVal,
                    permissions: perms
                })
            })
            .then(res => res.json())
            .then(data => {
                realBtn.innerText = btnText;
                if (data.status === 'success') {
                    alert("‚úÖ SUCCESS: User Saved to Database!");
                    
                    // Close Modal Manually
                    document.getElementById('create-user-modal').style.display = 'none';
                    document.getElementById('create-user-modal').classList.remove('open');
                    
                    // Clear Form Manually
                    nameInput.value = "";
                    emailInput.value = "";
                    passInput.value = "";
                    document.querySelectorAll('.permission-checkbox').forEach(b => b.classList.remove('checked'));
                } else {
                    alert("‚ùå Database Error: " + data.message);
                }
            })
            .catch(err => {
                realBtn.innerText = btnText;
                alert("Network Error: Is the server running?");
                console.error(err);
            });
        });
    }

    // Helper for Permissions Click (Visuals)
    document.querySelectorAll('.permission-checkbox').forEach(box => {
        box.addEventListener('click', function() {
             // Only toggle if not disabled (admin logic handled elsewhere)
             if(this.style.cursor !== 'not-allowed') {
                 this.classList.toggle('checked');
             }
        });
    });
    /* --- 1. ADD THIS FUNCTION (Connects to your Black Window) --- */
    function sendToRPC(endpoint, payload) {
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(data => console.log("‚úÖ RPC Response:", data))
        .catch(err => console.error("‚ùå RPC Error:", err));
    }

    /* --- 2. HARDWARE CONTROL (FIXED TOGGLE) --- */
    document.body.addEventListener('click', function(e) {
        // Find the toggle container
        const btn = e.target.closest('.toggle');
        
        if (btn) {
            // STOP the default browser click (prevents double-firing)
            e.preventDefault(); 
            
            // 1. CALCULATE NEW STATE
            // We check if it has the 'active' class to know if it's currently ON
            const isCurrentlyOn = btn.classList.contains('active') || btn.getAttribute('data-on') === 'true';
            const newState = !isCurrentlyOn; // Flip it
            
            // 2. VISUAL UPDATE (Force the slide animation)
            if (newState) {
                btn.classList.add('active');
                btn.setAttribute('data-on', 'true');
                // If there is a checkbox inside, check it
                const checkbox = btn.querySelector('input[type="checkbox"]');
                if(checkbox) checkbox.checked = true;
            } else {
                btn.classList.remove('active');
                btn.setAttribute('data-on', 'false');
                const checkbox = btn.querySelector('input[type="checkbox"]');
                if(checkbox) checkbox.checked = false;
            }

            // 3. GET DEVICE NAME
            let label = "Unknown Device";
            const card = btn.closest('.phone-card');
            if(card) {
                label = card.querySelector('.phone-card-label').innerText;
            } else {
                label = btn.getAttribute('aria-label') || "Door";
            }

            // 4. SEND TO BLACK WINDOW (RPC)
            console.log(`üì§ Switching ${label} -> ${newState ? "ON" : "OFF"}`);
            sendToRPC('/api/set_state/', { id: label, value: newState });
        }
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
// --- HISTORY LOGIC ---
document.getElementById('history-btn').addEventListener('click', () => {
    document.getElementById('history-modal').style.display = 'flex';
    loadLogs();
});
document.getElementById('history-close').addEventListener('click', () => {
    document.getElementById('history-modal').style.display = 'none';
});

document.getElementById('show-logs').addEventListener('click', loadLogs);
document.getElementById('show-sensors').addEventListener('click', loadSensors);

function loadLogs() {
    fetch('/api/logs/')
        .then(r => r.json())
        .then(data => {
            const list = document.getElementById('log-list');
            list.innerHTML = "<h4>User Actions</h4>";
            data.logs.forEach(l => {
                list.innerHTML += `<div style="border-bottom:1px solid #eee; padding:5px;">
                    <small>${l.time}</small> <strong>${l.device}</strong>: ${l.action}
                </div>`;
            });
        });
}

function loadSensors() {
    fetch('/api/sensors/')
        .then(r => r.json())
        .then(data => {
            const list = document.getElementById('log-list');
            list.innerHTML = "<h4>Sensor Data</h4>";
            data.data.forEach(s => {
                list.innerHTML += `<div style="border-bottom:1px solid #eee; padding:5px;">
                    <small>${s.time}</small> <strong>${s.type}</strong>: ${s.value} ${s.unit}
                </div>`;
            });
        });
}
  </script>
</body>
</html>